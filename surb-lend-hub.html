<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IMF AIDA &mdash; Surveillance and Lending Hub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,100..900&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', '-apple-system', 'sans-serif'] },
          colors: {
            imf: { navy: '#001D3D', blue: '#004C97', accent: '#4A90D9', light: '#EBF3FE', warm: '#F8FAFC' }
          }
        }
      }
    }
  </script>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    html { font-size: 17px; }
    body { margin: 0; font-family: 'Inter', system-ui, sans-serif; background: #F8FAFC; color: #1E293B; position: relative; }

    /* Side panel mode */
    .background-iframe {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
      z-index: 0;
      display: none;
    }
    .background-iframe.active {
      display: block;
      filter: blur(8px);
    }
    #app-container {
      position: relative;
      z-index: 1;
      display: flex;
      height: 100vh;
      transition: all 0.3s cubic-bezier(0.4,0,0.2,1);
    }
    #app-container.side-panel-mode {
      margin-left: auto;
      width: 600px;
      box-shadow: -4px 0 24px rgba(0,0,0,0.15);
    }

    /* Scrollbar */
    .scroll-y::-webkit-scrollbar { width: 5px; }
    .scroll-y::-webkit-scrollbar-track { background: transparent; }
    .scroll-y::-webkit-scrollbar-thumb { background: rgba(0,0,0,.15); border-radius: 3px; }

    /* Sidebar */
    .sidebar {
      width: 340px;
      min-width: 340px;
      transition: width 0.3s cubic-bezier(0.4,0,0.2,1), min-width 0.3s cubic-bezier(0.4,0,0.2,1), padding 0.3s ease;
      background: linear-gradient(175deg, #004C97 0%, #001D3D 100%);
    }
    .sidebar.collapsed { width: 0; min-width: 0; padding: 0; overflow: hidden; }
    .sidebar.collapsed * { opacity: 0; pointer-events: none; }

    /* Canvas (right panel) */
    .canvas-panel {
      width: 0; min-width: 0; overflow: hidden; opacity: 0;
      border-left: 0 solid #E2E8F0;
      transition: width 0.35s cubic-bezier(0.4,0,0.2,1), opacity 0.25s ease, min-width 0.35s ease, border-left-width 0.2s ease;
    }
    .canvas-panel.open { width: 70%; min-width: 70%; opacity: 1; border-left-width: 1px; }

    /* Case Preview Panel */
    .case-preview-panel {
      width: 0; min-width: 0; overflow: hidden; opacity: 0;
      border-left: 0 solid #E2E8F0;
      transition: width 0.35s cubic-bezier(0.4,0,0.2,1), opacity 0.25s ease, min-width 0.35s ease, border-left-width 0.2s ease;
    }
    .case-preview-panel.open { width: 760px; min-width: 760px; opacity: 1; border-left-width: 1px; }

    /* Citations Panel */
    .citations-panel {
      width: 0; min-width: 0; overflow: hidden; opacity: 0;
      border-left: 0 solid #E5E7EB;
      background: white;
      transition: width 0.35s cubic-bezier(0.4,0,0.2,1), opacity 0.25s ease, min-width 0.35s ease, border-left-width 0.2s ease;
    }
    .citations-panel.open { width: 340px; min-width: 340px; opacity: 1; border-left-width: 1px; }

    /* Conversation item — white card style */
    .conv-item { transition: all 0.12s ease; background: rgba(255,255,255,0.08); border: none; border-left: 3px solid transparent; }
    .conv-item:hover { background: rgba(255,255,255,0.14); }
    .conv-item.active { background: #fff; border: none; border-left: 3px solid #C239B3; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
    .conv-item p { font-size: 0.81rem; }
    .conv-item.active p { color: #1E293B !important; }
    /* Reduce spacing between conversation items */
    #chats-section-list > :not([hidden]) ~ :not([hidden]) { margin-top: 0.25rem !important; }
    /* Tags in conversation items - smaller font */
    .conv-item .tag { font-size: 10px; }
    /* Ticket tag (first tag) - outlined style */
    .conv-item .tag:first-child { background: transparent !important; border: 1px solid rgba(251,191,36,0.5); color: #FCD34D !important; }
    .conv-item.active .tag:first-child { background: transparent !important; border: 1px solid #F59E0B; color: #D97706 !important; }
    /* Status tag (last tag) - filled style */
    .conv-item.active .tag:last-child { background: rgba(59,130,246,0.15) !important; color: #2563EB !important; }
    .conv-item.filtered-out { display: none; }

    /* Nav link active state */
    .nav-link {
      transition: all 0.12s ease;
      border-radius: 8px;
      padding-left: 0.75rem;
    }
    .nav-link.active {
      background: rgba(255,255,255,0.95) !important;
      color: #1E293B !important;
      border-left: 3px solid #C239B3 !important;
      padding-left: 0.75rem !important;
      box-sizing: border-box !important;
    }
    .nav-link.active svg, .nav-link.active i { color: #1E293B !important; stroke: #1E293B !important; }

    /* Filter chip */
    .filter-chip { transition: all 0.15s ease; border: 1px solid rgba(255,255,255,0.2); }
    .filter-chip.active { background: rgba(255,255,255,0.2) !important; color: #fff !important; border-color: transparent; }
    .filter-chip:hover:not(.active) { background: rgba(255,255,255,0.08); }

    /* Chat bubbles */
    .bubble-user {
      background: linear-gradient(135deg, #004C97, #0060BF);
      color: #fff; border-radius: 18px 18px 4px 18px;
    }
    .bubble-ai {
      background: transparent; color: #1E293B; border-radius: 0;
      border: none; box-shadow: none;
    }

    /* Typing dots */
    @keyframes blink { 0%,80%,100%{opacity:.3} 40%{opacity:1} }
    .dot { animation: blink 1.4s infinite both; }
    .dot:nth-child(2) { animation-delay: .2s; }
    .dot:nth-child(3) { animation-delay: .4s; }

    /* Rich card */
    .rich-card {
      border: 1px solid #E2E8F0; border-radius: 12px; background: #fff;
      box-shadow: 0 1px 4px rgba(0,0,0,.04); transition: box-shadow 0.15s ease;
    }
    .rich-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,.07); }

    /* Tag */
    .tag { font-size: 11px; font-weight: 400; padding: 2px 8px; border-radius: 9999px; display: inline-flex; align-items: center; gap: 4px; border: none; }

    /* Step indicator */
    .step-dot { width: 8px; height: 8px; border-radius: 50%; background: #E2E8F0; transition: all 0.2s ease; cursor: pointer; }
    .step-dot.active { background: #004C97; box-shadow: 0 0 0 3px rgba(0,76,151,0.2); }
    .step-dot.done { background: #34D399; }

    /* Input container focus state */
    .chat-input-container { transition: border-color 0.2s ease; }
    .chat-input-container:focus-within { border-color: #2256A6 !important; }
    .chat-input:focus { outline: none; }

    /* Prompt cards - stack vertically in side panel mode */
    #app-container.side-panel-mode .prompt-cards-container {
      flex-direction: column !important;
    }

    /* Prompt cards - inline icon layout in side panel mode */
    #app-container.side-panel-mode .prompt-cards-container .act-btn {
      flex-direction: row !important;
      align-items: center !important;
    }

    /* Center initial greeting vertically on steps 0-1 in full screen mode */
    #chat-feed.center-content {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #chat-feed.center-content #messages {
      margin-top: 0;
      margin-bottom: 0;
    }

    /* Action button */
    .act-btn { transition: all 0.15s ease; }
    .act-btn:hover { background: #EBF3FE !important; border-color: #4A90D9 !important; }

    /* Smooth content appearance */
    .fade-in { animation: fadeIn 0.3s ease forwards; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }

    /* Spinner animation for AI avatar on step 2 */
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .spinner-ring {
      position: absolute;
      width: 48px;
      height: 48px;
      border: 2px solid transparent;
      border-top-color: #004C97;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      z-index: 0;
    }

    /* Checkbox */
    .chk { accent-color: #004C97; }

    /* Select dropdown */
    .sel-menu { display:none; }
    .sel-menu.open { display:block; }

    /* Accordion */
    .accordion-collapsed { display: none; }
    .chevron-rotated { transform: rotate(-90deg); transition: transform 0.2s ease; }
    .chevron-normal { transform: rotate(0deg); transition: transform 0.2s ease; }

    /* Tools Modal Tabs */
    .tools-tab {
      background: transparent;
      color: #6B7280;
      border: none;
      cursor: pointer;
    }

    .tools-tab:hover {
      background: #E5E7EB;
      color: #374151;
    }

    .tools-tab.active {
      background: #E5E7EB;
      color: #004C97;
      font-weight: 600;
      border-left: 3px solid #004C97;
    }

    .tools-content {
      display: block;
    }

    .tools-content.hidden {
      display: none;
    }

    /* Modal overlay animations */
    #tools-modal-overlay {
      animation: fadeInOverlay 0.2s ease;
    }

    @keyframes fadeInOverlay {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    #tools-modal-overlay > div {
      animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
  </style>
</head>
<body>
<!-- Background iframe for side panel mode -->
<iframe id="background-iframe" class="background-iframe" src="index-old.html"></iframe>

<div id="app-container" class="flex h-screen overflow-hidden">

  <!-- ============================== LEFT SIDEBAR ============================== -->
  <aside id="sidebar" class="sidebar flex flex-col py-4 px-3 flex-shrink-0 overflow-hidden">

    <!-- Logo + Collapse toggle -->
    <div class="mb-4 flex-shrink-0">
      <div class="flex items-center justify-between px-2 pb-4">
        <span class="text-white" style="font-size:1.75rem; line-height:1;"><b style="font-weight:700;">IMF</b> <span style="font-weight:400;">AIDA</span></span>
        <button onclick="toggleSidebar()" class="p-1.5 rounded-md bg-transparent border-none cursor-pointer" style="color:rgba(255,255,255,0.5);" onmouseenter="this.style.color='#fff';this.style.background='rgba(255,255,255,0.1)'" onmouseleave="this.style.color='rgba(255,255,255,0.5)';this.style.background='transparent'" title="Collapse sidebar">
          <i data-lucide="panel-left" class="w-[18px] h-[18px]"></i>
        </button>
      </div>

      <!-- Separator line -->
      <div class="mb-4" style="height: 1px; background: rgba(255,255,255,0.1);"></div>

      <!-- Agent label -->
      <button onclick="toggleAccordion('agent-section')" class="w-full flex items-center justify-between px-2 mb-1.5 mt-3 bg-transparent border-none cursor-pointer text-left">
        <p class="text-[10px] font-semibold uppercase tracking-wider" style="color:rgba(255,255,255,0.6);">Agent</p>
        <i id="agent-chevron" data-lucide="chevron-down" class="w-3.5 h-3.5" style="color:rgba(255,255,255,0.6);"></i>
      </button>

      <!-- Module selector -->
      <div id="agent-section" class="relative" id="module-sel">
        <button onclick="document.getElementById('sel-dd').classList.toggle('open')" class="w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm text-left cursor-pointer border-none" style="background:rgba(255,255,255,0.08); color:rgba(255,255,255,0.9);">
          <i data-lucide="landmark" class="w-4 h-4 flex-shrink-0" style="color:rgba(255,255,255,0.6);"></i>
          <span class="flex-1 truncate" id="sel-label">Surveillance & Lending Hub</span>
          <i data-lucide="chevron-down" class="w-3.5 h-3.5 flex-shrink-0" style="color:rgba(255,255,255,0.6);"></i>
        </button>
        <div id="sel-dd" class="sel-menu absolute left-0 right-0 mt-1 rounded-lg py-1 z-50" style="background:#fff; box-shadow:0 8px 24px rgba(0,0,0,.18); border:1px solid #E2E8F0;">
          <div class="px-2 py-1.5 text-[10px] font-semibold text-gray-400 uppercase tracking-wider">Select Agent</div>
          <button onclick="pickModule(this)" class="sel-opt flex items-center gap-2 w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 bg-transparent border-none cursor-pointer"><i data-lucide="book-open-check" class="w-4 h-4 text-imf-accent"></i>HR Policy Research</button>
          <button disabled class="sel-opt flex items-center gap-2 w-full text-left px-3 py-2 text-sm text-gray-400 bg-transparent border-none cursor-not-allowed opacity-50"><i data-lucide="scale" class="w-4 h-4 text-gray-400"></i>Ethics Guide</button>
          <button disabled class="sel-opt flex items-center gap-2 w-full text-left px-3 py-2 text-sm text-gray-400 bg-transparent border-none cursor-not-allowed opacity-50"><i data-lucide="plane" class="w-4 h-4 text-gray-400"></i>Travel Guide</button>
          <button onclick="pickModule(this)" class="sel-opt flex items-center gap-2 w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 bg-transparent border-none cursor-pointer"><i data-lucide="landmark" class="w-4 h-4 text-imf-accent"></i>Surveillance &amp; Lending Hub</button>
          <button disabled class="sel-opt flex items-center gap-2 w-full text-left px-3 py-2 text-sm text-gray-400 bg-transparent border-none cursor-not-allowed opacity-50"><i data-lucide="shield-check" class="w-4 h-4 text-gray-400"></i>Fin Safeguard</button>
          <button disabled class="sel-opt flex items-center gap-2 w-full text-left px-3 py-2 text-sm text-gray-400 bg-transparent border-none cursor-not-allowed opacity-50"><i data-lucide="file-text" class="w-4 h-4 text-gray-400"></i>TA Report Copilot</button>
          <button disabled class="sel-opt flex items-center gap-2 w-full text-left px-3 py-2 text-sm text-gray-400 bg-transparent border-none cursor-not-allowed opacity-50"><i data-lucide="gavel" class="w-4 h-4 text-gray-400"></i>SEC Board Keeper</button>
          <button disabled class="sel-opt flex items-center gap-2 w-full text-left px-3 py-2 text-sm text-gray-400 bg-transparent border-none cursor-not-allowed opacity-50"><i data-lucide="scan-search" class="w-4 h-4 text-gray-400"></i>Analyze Documents</button>
          <button disabled class="sel-opt flex items-center gap-2 w-full text-left px-3 py-2 text-sm text-gray-400 bg-transparent border-none cursor-not-allowed opacity-50"><i data-lucide="languages" class="w-4 h-4 text-gray-400"></i>Translate Documents</button>
        </div>
      </div>
    </div>

    <!-- Navigation links -->
    <div id="agent-section-nav" class="flex-shrink-0 px-1 mb-4">
      <button id="new-chat-link" onclick="goToStep(0)" class="nav-link w-full flex items-center gap-2.5 pr-3 py-2.5 rounded-lg text-sm bg-transparent border-none cursor-pointer text-left" style="color:rgba(255,255,255,0.9);" onmouseenter="if(!this.classList.contains('active'))this.style.background='rgba(255,255,255,0.08)'" onmouseleave="if(!this.classList.contains('active'))this.style.background='transparent'">
        <i data-lucide="message-circle" class="w-[18px] h-[18px] flex-shrink-0" style="color:rgba(255,255,255,0.7);"></i>
        <span>New Task</span>
      </button>
      <button id="search-explore-link" class="nav-link w-full flex items-center gap-2.5 pr-3 py-2.5 rounded-lg text-sm bg-transparent border-none cursor-pointer text-left" style="color:rgba(255,255,255,0.9);" onmouseenter="if(!this.classList.contains('active'))this.style.background='rgba(255,255,255,0.08)'" onmouseleave="if(!this.classList.contains('active'))this.style.background='transparent'">
        <i data-lucide="search" class="w-[18px] h-[18px] flex-shrink-0" style="color:rgba(255,255,255,0.7);"></i>
        <span>Search & Explore</span>
      </button>
      <button class="nav-link w-full flex items-center gap-2.5 pr-3 py-2.5 rounded-lg text-sm bg-transparent border-none cursor-pointer text-left" style="color:rgba(255,255,255,0.9);" onmouseenter="if(!this.classList.contains('active'))this.style.background='rgba(255,255,255,0.08)'" onmouseleave="if(!this.classList.contains('active'))this.style.background='transparent'">
        <i data-lucide="layout-template" class="w-[18px] h-[18px] flex-shrink-0" style="color:rgba(255,255,255,0.7);"></i>
        <span>Templates</span>
      </button>
    </div>

    <!-- Separator line -->
    <div class="mb-4 flex-shrink-0" style="height: 1px; background: rgba(255,255,255,0.1);"></div>

    <!-- Tasks label -->
    <button onclick="toggleAccordion('chats-section')" class="w-full flex items-center justify-between px-2 mb-2 flex-shrink-0 bg-transparent border-none cursor-pointer text-left">
      <p class="text-[10px] font-semibold uppercase tracking-wider" style="color:rgba(255,255,255,0.6);">Tasks</p>
      <i id="chats-chevron" data-lucide="chevron-down" class="w-3.5 h-3.5" style="color:rgba(255,255,255,0.6);"></i>
    </button>

    <!-- Search field -->
    <div id="chats-section-filters" class="mb-3 px-1 flex-shrink-0">
      <div class="relative">
        <i data-lucide="search" class="w-3.5 h-3.5 absolute left-2.5 top-1/2 transform -translate-y-1/2" style="color:rgba(255,255,255,0.5);"></i>
        <input type="text" placeholder="Search tasks..." class="w-full pl-8 pr-2.5 py-1 rounded-full bg-transparent border cursor-pointer" style="color:rgba(255,255,255,0.5); border-color:rgba(255,255,255,0.2); outline:none; font-size: 0.8rem;" />
      </div>
    </div>

    <!-- Conversations list -->
    <div id="chats-section-list" class="flex-1 overflow-y-auto scroll-y space-y-1.5 px-1" id="conv-list">
      <div class="text-[10px] font-semibold uppercase tracking-wider px-2 pt-2 pb-1 conv-date-header" style="color:rgba(255,255,255,0.6);">Today</div>

      <div class="conv-item rounded-lg px-3 py-2.5 cursor-pointer" data-type="case" data-status="open" onclick="goToStep(1)">
        <p class="text-sm font-normal truncate" style="color:rgba(255,255,255,0.9);">Multi-document comparative analysis</p>
      </div>

      <div class="conv-item rounded-lg px-3 py-2.5 cursor-pointer" data-type="case" data-status="closed">
        <p class="text-sm font-normal truncate" style="color:rgba(255,255,255,0.9);">Search & ingest lending documents</p>
      </div>

      <div class="conv-item rounded-lg px-3 py-2.5 cursor-pointer" data-type="case" data-status="open">
        <p class="text-sm font-normal truncate" style="color:rgba(255,255,255,0.9);">Template editing with AI assistance</p>
      </div>

      <div class="text-[10px] font-semibold uppercase tracking-wider px-2 pt-4 pb-1 conv-date-header" style="color:rgba(255,255,255,0.6);">Yesterday</div>

      <div class="conv-item rounded-lg px-3 py-2.5 cursor-pointer" data-type="chat" data-status="closed">
        <p class="text-sm font-normal truncate" style="color:rgba(255,255,255,0.9);">Compliance risk flagging in loan docs</p>
      </div>

      <div class="conv-item rounded-lg px-3 py-2.5 cursor-pointer" data-type="case" data-status="closed">
        <p class="text-sm font-normal truncate" style="color:rgba(255,255,255,0.9);">Search criteria refinement & saved queries</p>
      </div>

      <div class="text-[10px] font-semibold uppercase tracking-wider px-2 pt-4 pb-1 conv-date-header" style="color:rgba(255,255,255,0.6);">Last 7 Days</div>

      <div class="conv-item rounded-lg px-3 py-2.5 cursor-pointer" data-type="chat" data-status="closed">
        <p class="text-sm font-normal truncate" style="color:rgba(255,255,255,0.9);">Export generated surveillance reports</p>
      </div>

      <div class="conv-item rounded-lg px-3 py-2.5 cursor-pointer" data-type="case" data-status="closed">
        <p class="text-sm font-normal truncate" style="color:rgba(255,255,255,0.9);">Document ingestion from repository</p>
      </div>

      <div class="conv-item rounded-lg px-3 py-2.5 cursor-pointer" data-type="chat" data-status="closed">
        <p class="text-sm font-normal truncate" style="color:rgba(255,255,255,0.9);">Inline citation list review</p>
      </div>

      <div class="conv-item rounded-lg px-3 py-2.5 cursor-pointer" data-type="case" data-status="closed">
        <p class="text-sm font-normal truncate" style="color:rgba(255,255,255,0.9);">Difference analysis between versions</p>
      </div>
    </div>

    <!-- User block -->
    <div class="flex-shrink-0 mt-3 pt-3" style="border-top: 1px solid rgba(255,255,255,0.1);">
      <div class="flex items-center gap-2.5 px-2">
        <img src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?ixlib=rb-1.2.1&auto=format&fit=facearea&facepad=2&w=256&h=256&q=80" alt="Avatar" class="w-9 h-9 rounded-full object-cover flex-shrink-0" style="border: 2px solid rgba(255,255,255,0.2);" />
        <div class="min-w-0">
          <p class="text-sm font-medium text-white truncate">John Miller</p>
          <p class="text-[11px] truncate" style="color:rgba(255,255,255,0.45);">Senior Economist</p>
        </div>
        <button class="ml-auto p-1.5 rounded-md bg-transparent border-none cursor-pointer" style="color:rgba(255,255,255,0.4);" title="Settings">
          <i data-lucide="settings" class="w-4 h-4"></i>
        </button>
      </div>
    </div>
  </aside>

  <!-- ============================== MAIN AREA ============================== -->
  <div class="flex-1 flex flex-col min-w-0">

    <!-- Top bar -->
    <header class="h-13 flex items-center justify-between px-5 flex-shrink-0 bg-white border-b border-gray-200" style="height:52px;">
      <div class="flex items-center gap-3">
        <button id="header-toggle-btn" onclick="toggleSidebar()" class="p-1.5 rounded-md hover:bg-gray-100 bg-transparent border-none cursor-pointer text-gray-500" style="display:none;" title="Toggle sidebar">
          <i data-lucide="panel-left" class="w-[18px] h-[18px]"></i>
        </button>
        <button id="side-panel-nav-btn" onclick="toggleSidebar()" class="p-1.5 rounded-md hover:bg-gray-100 bg-transparent border-none cursor-pointer text-gray-500" style="display:none;" title="Expand navigation">
          <i data-lucide="panel-left" class="w-[18px] h-[18px]"></i>
        </button>
        <h1 id="conv-title" class="text-base font-semibold text-gray-800">Surveillance and Lending Hub</h1>
      </div>
      <div class="flex items-center gap-1.5">
        <button onclick="prevStep()" class="p-1.5 rounded-md hover:bg-gray-100 bg-transparent border-none cursor-pointer text-gray-400" title="Previous step"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
        <span class="text-xs font-medium text-gray-500 min-w-[80px] text-center" id="step-label">Step 1 of 10</span>
        <button onclick="nextStep()" class="p-1.5 rounded-md hover:bg-gray-100 bg-transparent border-none cursor-pointer text-gray-400" title="Next step"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
        <!-- Minimize/Maximize button -->
      </div>
    </header>

    <!-- Chat + Canvas row -->
    <div class="flex flex-1 min-h-0">

      <!-- ============================== CHAT AREA ============================== -->
      <div class="flex-1 flex flex-col min-w-[420px]" style="background: linear-gradient(180deg, #F8FAFC 0%, #F1F5F9 100%);">
        <div class="flex-1 relative">
          <div id="chat-feed" class="absolute inset-0 overflow-y-auto scroll-y px-6 py-6">
            <div class="max-w-[760px] mx-auto space-y-5" id="messages"></div>
          </div>
          <!-- Scroll gradient overlay -->
          <div id="scroll-gradient" class="pointer-events-none absolute bottom-0 left-0 right-0 h-32 opacity-0 transition-opacity duration-300" style="background: linear-gradient(to top, rgba(241,245,249,1) 0%, rgba(241,245,249,0) 100%);"></div>
        </div>

        <!-- Input area (bottom fixed - shown from step 3+) -->
        <div id="bottom-input-area" class="flex-shrink-0 px-6 pb-5 pt-2" style="display: none;">
          <div class="mx-auto">
            <!-- Active filter tags (shown in step 6+) -->
            <div id="filter-tags" class="hidden flex-wrap gap-1.5 mb-2"></div>
            <div class="chat-input-container bg-white rounded-2xl px-4 py-3 border border-gray-200" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
              <textarea id="chat-input" rows="2" placeholder="Ask me about surveillance reports, lending programs, or country analysis..." class="chat-input w-full text-sm border-none outline-none bg-transparent text-gray-800 resize-none mb-2" style="line-height: 1.5;" autofocus></textarea>
              <div class="flex items-center justify-between gap-2">
                <div class="flex items-center gap-1">
                  <button class="p-1.5 rounded-md hover:bg-gray-100 bg-transparent border-none cursor-pointer text-gray-600 flex-shrink-0"><i data-lucide="paperclip" class="w-[18px] h-[18px]"></i></button>
                  <button onclick="openToolsModal()" class="flex items-center gap-1.5 px-2.5 py-1.5 rounded-md hover:bg-gray-100 bg-transparent border-none cursor-pointer text-gray-600 flex-shrink-0"><i data-lucide="sliders-horizontal" class="w-[18px] h-[18px]"></i><span class="text-sm">Tools</span></button>
                  <div id="ticket-chip-bottom" class="hidden"></div>
                </div>
                <div class="flex items-center gap-1">
                  <button class="p-1.5 rounded-md hover:bg-gray-100 bg-transparent border-none cursor-pointer text-gray-600 flex-shrink-0"><i data-lucide="mic" class="w-[18px] h-[18px]"></i></button>
                  <button id="send-stop-btn" onclick="nextStep()" class="p-2 rounded-xl border-none cursor-pointer text-white flex-shrink-0" style="background:linear-gradient(135deg,#004C97,#0060BF);"><i data-lucide="arrow-up" class="w-4 h-4"></i></button>
                </div>
              </div>
            </div>
            <p class="text-[11px] mt-2 text-center" style="color: #6B7785; font-weight: 300 !important;">AIDA may produce inaccurate information. Always verify it and align to IMF policies.</p>
          </div>
        </div>
      </div>

      <!-- ============================== CASE PREVIEW PANEL ============================== -->
      <div id="case-preview-panel" class="case-preview-panel flex flex-col bg-white">
        <div id="case-preview-content" class="flex-1 overflow-y-auto scroll-y p-6" style="width:760px;"></div>
      </div>

      <!-- ============================== CANVAS PANEL ============================== -->
      <div id="canvas-panel" class="canvas-panel flex bg-white">
        <div id="canvas-content" class="flex-1 overflow-y-auto scroll-y p-6"></div>

        <!-- ============================== CITATIONS PANEL (INSIDE CANVAS) ============================== -->
        <div id="citations-panel" class="citations-panel flex flex-col bg-white">
          <div id="citations-content" class="flex-1 overflow-y-auto scroll-y p-6"></div>
        </div>
      </div>

    </div>

    <!-- ============================== TOOLS MODAL ============================== -->
    <div id="tools-modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden" style="z-index: 1000;" onclick="closeToolsModal(event)">
      <div class="bg-white rounded-xl shadow-2xl flex flex-col" style="width: 800px; max-height: 600px;" onclick="event.stopPropagation()">
        <!-- Modal Header -->
        <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-800">Research Tools</h3>
          <button onclick="closeToolsModal()" class="p-1 rounded-md hover:bg-gray-100 text-gray-400 hover:text-gray-600 bg-transparent border-none cursor-pointer">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>

        <!-- Modal Body - Two Columns -->
        <div class="flex flex-1 overflow-hidden">
          <!-- Left Column: Tabs -->
          <div class="w-48 border-r border-gray-200 bg-gray-50 p-4 space-y-1">
            <button id="tab-filter" onclick="switchToolsTab('filter')" class="tools-tab active w-full text-left px-3 py-2 rounded-md text-sm font-medium transition-colors">
              Filter the results
            </button>
            <button id="tab-relevance" onclick="switchToolsTab('relevance')" class="tools-tab w-full text-left px-3 py-2 rounded-md text-sm font-medium transition-colors">
              Relevance
            </button>
            <button id="tab-sources" onclick="switchToolsTab('sources')" class="tools-tab w-full text-left px-3 py-2 rounded-md text-sm font-medium transition-colors">
              Sources
            </button>
          </div>

          <!-- Right Column: Content -->
          <div class="flex-1 overflow-y-auto p-6">
            <!-- Filter Tab Content -->
            <div id="content-filter" class="tools-content">
              <!-- Date Range -->
              <div class="mb-6">
                <label class="block text-gray-700 mb-2" style="font-size: 0.75rem; font-weight: 600; letter-spacing: 0.03rem;">DATE RANGE</label>
                <div class="flex items-center gap-3">
                  <input type="text" placeholder="01/02/2024" class="flex-1 text-sm border border-gray-200 rounded-lg px-3 py-2 outline-none focus:border-imf-accent">
                  <span class="text-sm text-gray-400">to</span>
                  <input type="text" placeholder="01/02/2025" class="flex-1 text-sm border border-gray-200 rounded-lg px-3 py-2 outline-none focus:border-imf-accent">
                </div>
              </div>

              <!-- Department -->
              <div class="mb-6">
                <label class="block text-gray-700 mb-2" style="font-size: 0.75rem; font-weight: 600; letter-spacing: 0.03rem;">DEPARTMENT</label>
                <select class="w-full text-sm border border-gray-200 rounded-lg px-3 py-2 outline-none focus:border-imf-accent bg-white">
                  <option>All Departments</option>
                  <option>Finance</option>
                  <option>Research</option>
                  <option>IT Services</option>
                  <option>Legal</option>
                  <option>Communications</option>
                </select>
              </div>

              <!-- Case Type -->
              <div class="mb-6">
                <label class="block text-gray-700 mb-2" style="font-size: 0.75rem; font-weight: 600; letter-spacing: 0.03rem;">CASE TYPE</label>
                <div class="space-y-2">
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" checked class="w-4 h-4 rounded border-2 border-gray-300 cursor-pointer" style="accent-color: #004C97;">
                    <span class="text-sm text-gray-700">Medical complications</span>
                  </label>
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" class="w-4 h-4 rounded border-2 border-gray-300 cursor-pointer" style="accent-color: #004C97;">
                    <span class="text-sm text-gray-700">Multiple births</span>
                  </label>
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" class="w-4 h-4 rounded border-2 border-gray-300 cursor-pointer" style="accent-color: #004C97;">
                    <span class="text-sm text-gray-700">International assignments</span>
                  </label>
                </div>
              </div>

              <!-- Approval Level -->
              <div class="mb-6">
                <label class="block text-gray-700 mb-2" style="font-size: 0.75rem; font-weight: 600; letter-spacing: 0.03rem;">APPROVAL LEVEL</label>
                <div class="space-y-2">
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="approval" class="w-4 h-4 border-gray-300 text-imf-blue focus:ring-imf-blue">
                    <span class="text-sm text-gray-700">Any</span>
                  </label>
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="approval" class="w-4 h-4 border-gray-300 text-imf-blue focus:ring-imf-blue">
                    <span class="text-sm text-gray-700">HR Director</span>
                  </label>
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="approval" class="w-4 h-4 border-gray-300 text-imf-blue focus:ring-imf-blue">
                    <span class="text-sm text-gray-700">Division Chief</span>
                  </label>
                </div>
              </div>
            </div>

            <!-- Relevance Tab Content -->
            <div id="content-relevance" class="tools-content hidden">
              <div class="mb-6">
                <div class="flex items-center gap-2 mb-3">
                  <label class="text-gray-700" style="font-size: 0.75rem; font-weight: 600; letter-spacing: 0.03rem;">MIN. RELEVANCE %</label>
                  <button class="p-1 text-gray-400 hover:text-gray-600 bg-transparent border-none cursor-pointer" title="Set the minimum relevance score for search results">
                    <i data-lucide="info" class="w-4 h-4"></i>
                  </button>
                </div>
                <div class="space-y-3">
                  <input type="range" min="0" max="100" value="75" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-imf-accent" id="relevance-slider">
                  <div class="flex justify-between text-xs text-gray-500">
                    <span>0%</span>
                    <span id="relevance-value" class="font-semibold text-imf-accent">75%</span>
                    <span>100%</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Sources Tab Content -->
            <div id="content-sources" class="tools-content hidden">
              <div class="space-y-2">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" checked class="w-4 h-4 rounded border-2 border-gray-300 cursor-pointer" style="accent-color: #004C97;">
                  <span class="text-sm text-gray-700">OneDrive / SharePoint</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" checked class="w-4 h-4 rounded border-2 border-gray-300 cursor-pointer" style="accent-color: #004C97;">
                  <span class="text-sm text-gray-700">ServiceNow</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" checked class="w-4 h-4 rounded border-2 border-gray-300 cursor-pointer" style="accent-color: #004C97;">
                  <span class="text-sm text-gray-700">Outlook (Ethics Inbox)</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" checked class="w-4 h-4 rounded border-2 border-gray-300 cursor-pointer" style="accent-color: #004C97;">
                  <span class="text-sm text-gray-700">Outlook (HR Inbox)</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" checked class="w-4 h-4 rounded border-2 border-gray-300 cursor-pointer" style="accent-color: #004C97;">
                  <span class="text-sm text-gray-700">PeopleSoft</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" checked class="w-4 h-4 rounded border-2 border-gray-300 cursor-pointer" style="accent-color: #004C97;">
                  <span class="text-sm text-gray-700">Nexus</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" checked class="w-4 h-4 rounded border-2 border-gray-300 cursor-pointer" style="accent-color: #004C97;">
                  <span class="text-sm text-gray-700">Caseload Manager</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" checked class="w-4 h-4 rounded border-2 border-gray-300 cursor-pointer" style="accent-color: #004C97;">
                  <span class="text-sm text-gray-700">HRD Excel Tracker</span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Modal Footer -->
        <div class="flex items-center justify-end gap-3 px-6 py-4 border-t border-gray-200 bg-gray-50 rounded-b-xl">
          <button onclick="closeToolsModal()" class="px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-lg bg-transparent border border-gray-300 cursor-pointer">
            Cancel
          </button>
          <button onclick="applyToolsFilters()" class="px-4 py-2 text-sm font-medium text-white rounded-lg cursor-pointer border-none" style="background:linear-gradient(135deg,#004C97,#0060BF);">
            Apply
          </button>
        </div>
      </div>
    </div>

    <!-- ============================== CHECKLIST MODAL ============================== -->
    <div id="checklist-modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden" style="z-index: 1000;" onclick="closeChecklistModal(event)">
      <div class="bg-white rounded-xl shadow-2xl" style="width: 500px;" onclick="event.stopPropagation()">
        <!-- Modal Header -->
        <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-800">Pre-send Checklist</h3>
          <button onclick="closeChecklistModal()" class="p-1 rounded-md hover:bg-gray-100 text-gray-400 hover:text-gray-600 bg-transparent border-none cursor-pointer">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>

        <!-- Modal Body -->
        <div class="px-6 py-6 space-y-4">
          <label class="flex items-start gap-3 cursor-pointer">
            <input type="checkbox" id="check-1" checked class="mt-1 w-4 h-4 rounded border-2 border-gray-300 text-imf-accent focus:ring-2 focus:ring-imf-accent cursor-pointer" style="accent-color: #004C97;">
            <span class="text-gray-800 flex-1" style="font-size: 0.9rem;">I have reviewed the draft content</span>
          </label>
          <label class="flex items-start gap-3 cursor-pointer">
            <input type="checkbox" id="check-2" checked class="mt-1 w-4 h-4 rounded border-2 border-gray-300 text-imf-accent focus:ring-2 focus:ring-imf-accent cursor-pointer" style="accent-color: #004C97;">
            <span class="text-gray-800 flex-1" style="font-size: 0.9rem;">Precedents cited are applicable</span>
          </label>
          <label class="flex items-start gap-3 cursor-pointer">
            <input type="checkbox" id="check-3" checked class="mt-1 w-4 h-4 rounded border-2 border-gray-300 text-imf-accent focus:ring-2 focus:ring-imf-accent cursor-pointer" style="accent-color: #004C97;">
            <span class="text-gray-800 flex-1" style="font-size: 0.9rem;">Employee details are correct</span>
          </label>
          <label class="flex items-start gap-3 cursor-pointer">
            <input type="checkbox" id="check-4" class="mt-1 w-4 h-4 rounded border-2 border-gray-300 text-imf-accent focus:ring-2 focus:ring-imf-accent cursor-pointer" style="accent-color: #004C97;">
            <span class="text-gray-800 flex-1" style="font-size: 0.9rem;">This aligns with current HR policy</span>
          </label>
        </div>

        <!-- Modal Footer -->
        <div class="flex items-center justify-end gap-3 px-6 py-4 border-t border-gray-200 bg-gray-50 rounded-b-xl">
          <button onclick="closeChecklistModal()" class="px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-lg bg-transparent border border-gray-300 cursor-pointer">
            Cancel
          </button>
          <button onclick="confirmSendEmail()" class="px-4 py-2 text-sm font-medium text-white rounded-lg cursor-pointer border-none" style="background:linear-gradient(135deg,#004C97,#0060BF);">
            Send Email
          </button>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
lucide.createIcons();

/* ────── State ────── */
let currentStep = 0;
const totalSteps = 1;

/* ────── Tools Modal Functions ────── */
function openToolsModal() {
  const modal = document.getElementById('tools-modal-overlay');
  modal.classList.remove('hidden');
  document.body.style.overflow = 'hidden'; // Prevent background scrolling

  // Initialize slider listener if on relevance tab
  const slider = document.getElementById('relevance-slider');
  if (slider) {
    slider.addEventListener('input', updateRelevanceValue);
  }

  lucide.createIcons(); // Re-render lucide icons
}

function closeToolsModal(event) {
  // Only close if clicking overlay or close button, not modal content
  if (event && event.target !== event.currentTarget && !event.target.closest('button[onclick*="closeToolsModal"]')) return;

  const modal = document.getElementById('tools-modal-overlay');
  modal.classList.add('hidden');
  document.body.style.overflow = ''; // Restore scrolling
}

function switchToolsTab(tabName) {
  // Update tab buttons
  document.querySelectorAll('.tools-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  document.getElementById('tab-' + tabName).classList.add('active');

  // Update content panels
  document.querySelectorAll('.tools-content').forEach(content => {
    content.classList.add('hidden');
  });
  document.getElementById('content-' + tabName).classList.remove('hidden');

  lucide.createIcons(); // Re-render icons for new content
}

function updateRelevanceValue() {
  const slider = document.getElementById('relevance-slider');
  const valueDisplay = document.getElementById('relevance-value');
  if (slider && valueDisplay) {
    valueDisplay.textContent = slider.value + '%';
  }
}

/* ────── Checklist Modal Functions ────── */
function openChecklistModal() {
  const modal = document.getElementById('checklist-modal-overlay');
  modal.classList.remove('hidden');
  document.body.style.overflow = 'hidden'; // Prevent background scrolling
}

function closeChecklistModal(event) {
  // Only close if clicking overlay or explicit close button
  if (event && event.target !== event.currentTarget && !event.target.closest('button[onclick*="closeChecklistModal"]')) return;

  const modal = document.getElementById('checklist-modal-overlay');
  modal.classList.add('hidden');
  document.body.style.overflow = 'auto'; // Re-enable scrolling
}

function confirmSendEmail() {
  // 1. Close the modal
  closeChecklistModal();

  // 2. Close the right side panel (canvas panel)
  const canvasPanel = document.getElementById('canvas-panel');
  if (canvasPanel) {
    canvasPanel.classList.remove('open');
  }

  // 3. Open back the left nav (expand sidebar)
  const sidebar = document.getElementById('sidebar');
  const headerToggle = document.getElementById('header-toggle-btn');
  if (sidebar && sidebar.classList.contains('collapsed')) {
    sidebar.classList.remove('collapsed');
    if (headerToggle) {
      headerToggle.style.display = 'none';
    }
  }

  // 4. Move to step 7 which will show the new message
  nextStep();
}

function applyToolsFilters() {
  // TODO: Implement filter application logic
  // For now, just close the modal
  closeToolsModal();

  // Could add logic here to:
  // 1. Collect filter values
  // 2. Update UI with filter tags
  // 3. Trigger search/filter action
}

// Keyboard support for modal
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    const modal = document.getElementById('tools-modal-overlay');
    if (modal && !modal.classList.contains('hidden')) {
      closeToolsModal();
    }
  }
});

/* ────── Sidebar ────── */
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const headerToggle = document.getElementById('header-toggle-btn');
  sidebar.classList.toggle('collapsed');
  // Show header toggle only when sidebar is collapsed
  headerToggle.style.display = sidebar.classList.contains('collapsed') ? '' : 'none';
}

/* ────── Side Panel Mode ────── */
let sidebarStateBeforePanelMode = false; // Track if sidebar was collapsed before entering side panel mode

function togglePanelMode() {
  const appContainer = document.getElementById('app-container');
  const backgroundIframe = document.getElementById('background-iframe');
  const sidebar = document.getElementById('sidebar');
  const panelToggleBtn = document.getElementById('panel-toggle-btn');
  const panelToggleIcon = panelToggleBtn ? panelToggleBtn.querySelector('i') : null;
  const sidePanelNavBtn = document.getElementById('side-panel-nav-btn');
  const headerToggleBtn = document.getElementById('header-toggle-btn');

  const isSidePanelMode = appContainer.classList.toggle('side-panel-mode');
  if (backgroundIframe) backgroundIframe.classList.toggle('active');

  if (isSidePanelMode) {
    // Entering side panel mode - save current sidebar state
    if (sidebar) sidebarStateBeforePanelMode = sidebar.classList.contains('collapsed');

    // Hide sidebar and show navigation button
    if (sidebar) sidebar.style.display = 'none';
    if (headerToggleBtn) headerToggleBtn.style.display = 'none';
    if (panelToggleIcon) panelToggleIcon.setAttribute('data-lucide', 'maximize');
    if (panelToggleBtn) panelToggleBtn.title = 'Maximize to full screen';
    if (sidePanelNavBtn) sidePanelNavBtn.style.display = 'block';
  } else {
    // Exiting side panel mode - restore previous sidebar state
    if (sidebar) sidebar.style.display = '';
    if (sidebarStateBeforePanelMode) {
      // Sidebar was collapsed before, keep it collapsed and show header toggle
      if (headerToggleBtn) headerToggleBtn.style.display = '';
    } else {
      // Sidebar was visible before, keep it visible
      if (sidebar) sidebar.classList.remove('collapsed');
      if (headerToggleBtn) headerToggleBtn.style.display = 'none';
    }
    if (panelToggleIcon) panelToggleIcon.setAttribute('data-lucide', 'minimize');
    if (panelToggleBtn) panelToggleBtn.title = 'Minimize to side panel';
    if (sidePanelNavBtn) sidePanelNavBtn.style.display = 'none';
  }

  // Update bottom input visibility first
  const bottomInputArea = document.getElementById('bottom-input-area');
  if (isSidePanelMode || currentStep >= 2) {
    bottomInputArea.style.display = 'block';
  } else {
    bottomInputArea.style.display = 'none';
  }

  // Re-render content to apply side panel mode changes
  renderUpToStep(currentStep);

  // Reinitialize lucide icons
  lucide.createIcons();
}

/* ────── Accordion ────── */
function toggleAccordion(sectionId) {
  const chevronId = sectionId === 'agent-section' ? 'agent-chevron' : 'chats-chevron';
  const chevron = document.getElementById(chevronId);

  if (sectionId === 'agent-section') {
    const selector = document.getElementById('agent-section');
    const nav = document.getElementById('agent-section-nav');
    selector.classList.toggle('accordion-collapsed');
    nav.classList.toggle('accordion-collapsed');
    chevron.classList.toggle('chevron-rotated');
  } else if (sectionId === 'chats-section') {
    const filters = document.getElementById('chats-section-filters');
    const list = document.getElementById('chats-section-list');
    filters.classList.toggle('accordion-collapsed');
    list.classList.toggle('accordion-collapsed');
    chevron.classList.toggle('chevron-rotated');
  }
}

/* ────── Module selector ────── */
function pickModule(btn) {
  const moduleName = btn.textContent.trim();

  // Navigate to specific pages
  if (moduleName === 'Surveillance & Lending Hub') {
    window.location.href = 'surb-lend-hub.html';
    return;
  }

  if (moduleName === 'HR Policy Research') {
    window.location.href = 'index.html';
    return;
  }

  document.getElementById('sel-label').textContent = moduleName;
  document.getElementById('sel-dd').classList.remove('open');
}
document.addEventListener('click', e => {
  const sel = document.getElementById('module-sel');
  if (sel && !sel.contains(e.target)) document.getElementById('sel-dd').classList.remove('open');
});

/* ────── Filter chips ────── */
function setFilter(el, filter) {
  document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  // Apply filter to conversation items
  const items = document.querySelectorAll('.conv-item');
  const headers = document.querySelectorAll('.conv-date-header');
  items.forEach(item => {
    const type = item.dataset.type; // 'case' or 'chat'
    const status = item.dataset.status; // 'open' or 'closed'
    let show = true;
    if (filter === 'cases') show = type === 'case';
    else if (filter === 'chats') show = type === 'chat';
    else if (filter === 'open') show = status === 'open';
    else if (filter === 'closed') show = status === 'closed';
    item.classList.toggle('filtered-out', !show);
  });
  // Show/hide date headers if all their following items are hidden
  headers.forEach(h => {
    let next = h.nextElementSibling;
    let anyVisible = false;
    while (next && !next.classList.contains('conv-date-header')) {
      if (next.classList.contains('conv-item') && !next.classList.contains('filtered-out')) anyVisible = true;
      next = next.nextElementSibling;
    }
    h.style.display = anyVisible ? '' : 'none';
  });
}

/* ────── Prompt card click → fill input ────── */
function fillPrompt(text) {
  // Redirect to HR summary page for this specific prompt
  if (text === 'Summarize open cases for weekly HR meeting') {
    window.location.href = 'hr-summary.html';
    return;
  }

  document.getElementById('chat-input').value = text;
  document.getElementById('chat-input').focus();
}

/* ────── Steps ────── */
function buildDots() {
  document.getElementById('step-label').textContent = `Step ${currentStep+1} of ${totalSteps}`;
}

function goToStep(n) {
  if (n < 0 || n >= totalSteps) return;
  currentStep = n;

  // Close citations panel when navigating to next step
  closeCitationsPanel();

  buildDots();
  renderUpToStep(currentStep);

  // Update title based on step
  const titleEl = document.getElementById('conv-title');
  if (currentStep >= 1) {
    titleEl.textContent = 'REQ0012345: Parental leave extension request';
  } else {
    titleEl.textContent = 'New chat';
  }

  // Show/hide bottom input area based on step (always show in side panel mode)
  const bottomInputArea = document.getElementById('bottom-input-area');
  const appContainer = document.getElementById('app-container');
  const isSidePanelMode = appContainer.classList.contains('side-panel-mode');

  if (isSidePanelMode || currentStep >= 2) {
    bottomInputArea.style.display = 'block';
  } else {
    bottomInputArea.style.display = 'none';
  }

  // Update active states
  const newChatLink = document.getElementById('new-chat-link');
  const convItems = document.querySelectorAll('.conv-item');

  if (currentStep === 0) {
    // Step 0: New chat is active
    newChatLink.classList.add('active');
    convItems.forEach(item => item.classList.remove('active'));
  } else {
    // Steps 1+: Conversation item is active
    newChatLink.classList.remove('active');
    // Make first conv item active (the REQ0012345 one)
    convItems.forEach((item, idx) => {
      if (idx === 0) item.classList.add('active');
      else item.classList.remove('active');
    });
  }
}
function nextStep() { goToStep(currentStep + 1); }
function prevStep() { goToStep(currentStep - 1); }

/* ────── Render helpers ────── */
function userMsg(text, extra='') {
  return `<div class="flex justify-end fade-in"><div class="max-w-[85%]"><div class="bubble-user px-4 py-3 text-sm leading-relaxed">${text}</div>${extra ? '<div class="mt-1.5 flex justify-end">'+extra+'</div>' : ''}</div></div>`;
}

function aiMsg(html) {
  return `<div class="flex justify-start fade-in"><div class="max-w-[100%]"><div class="bubble-ai text-sm leading-relaxed">${html}</div></div></div>`;
}

function ticketBanner() {
  return `<div class="fade-in rounded-xl px-4 py-3 flex flex-wrap items-center gap-3 text-sm" style="background:linear-gradient(135deg,#FEF3C7,#FDE68A20); border:1px solid #FDE68A;">
    <span class="text-lg">&#127915;</span>
    <div class="flex-1" style="min-width: 200px;">
      <span class="font-semibold text-amber-900">REQ0012345:&nbsp;</span>
      <span class="text-amber-800">Parental leave extension request</span>
      <p class="text-amber-800 text-xs mt-0.5">John Smith (Finance Dept)</p>
      <div class="mt-0">
        <span class="text-amber-800 text-xs">Priority: Medium</span>
      </div>
      <div class="flex items-center gap-1.5 mt-0">
        <span class="text-amber-800 text-xs">Status:</span>
        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs" style="background:rgba(59,130,246,0.2); color:#3B82F6;">In Progress</span>
      </div>
    </div>
    <div class="flex gap-2">
      <button class="text-xs font-medium text-amber-800 hover:bg-amber-100 bg-transparent cursor-pointer px-3 py-1.5 rounded-md" style="border: 1px solid #92400E;">View in ServiceNow &#8599;</button>
      <button class="p-1.5 rounded-md hover:bg-amber-100 bg-transparent border-none cursor-pointer text-amber-800 flex items-center justify-center"><i data-lucide="ellipsis-vertical" class="w-4 h-4"></i></button>
    </div>
  </div>`;
}

function promptCards() {
  const items = [
    { icon: 'icons/document-sparkle.svg', t: 'Compare surveillance reports across multiple countries', isCustom: true },
    { icon: 'icons/search-sparkle.svg', t: 'Search for lending conditionality examples', isCustom: true },
    { icon: 'icons/search-sparkle.svg', t: 'Find similar Article IV consultation reports', isCustom: true },
    { icon: 'icons/form-sparkle.svg', t: 'Generate staff report from template', isCustom: true },
    { icon: 'icons/math-func-sparkle.svg', t: 'Flag compliance issues in loan documents', isCustom: true },
  ];
  return `<div class="prompt-cards-container flex flex-col gap-2 mt-6 fade-in">${items.map(i => {
    const iconHtml = i.isCustom
      ? `<img src="${i.icon}" class="w-5 h-5 flex-shrink-0" alt="" />`
      : `<i data-lucide="${i.icon}" class="w-5 h-5 flex-shrink-0" style="color: #2256A6;"></i>`;
    return `<button onclick="fillPrompt('${i.t}')" class="act-btn flex items-center gap-3 px-4 py-4 rounded-xl bg-white border border-gray-300 cursor-pointer hover:border-imf-accent hover:bg-gray-50 transition-all" style="box-shadow: 0 2px 8px rgba(0,0,0,.04); width: 100%;">${iconHtml}<span class="text-left" style="font-size: 0.8rem; line-height: 1.15rem; font-weight: 400; color: #374151;">${i.t}</span></button>`;
  }).join('')}</div></div>`;
}

function feedbackBtns() {
  return `<div class="flex items-center gap-1 mt-3" style="border-top:1px solid #F1F5F9;">
    <button class="p-1.5 rounded-md hover:bg-gray-100 bg-transparent border-none cursor-pointer text-gray-400" title="Copy"><i data-lucide="copy" class="w-3.5 h-3.5"></i></button>
    <button class="p-1.5 rounded-md hover:bg-gray-100 bg-transparent border-none cursor-pointer text-gray-400" title="Helpful"><i data-lucide="thumbs-up" class="w-3.5 h-3.5"></i></button>
    <button class="p-1.5 rounded-md hover:bg-gray-100 bg-transparent border-none cursor-pointer text-gray-400" title="Not helpful"><i data-lucide="thumbs-down" class="w-3.5 h-3.5"></i></button>
    <button class="p-1.5 rounded-md hover:bg-gray-100 bg-transparent border-none cursor-pointer text-gray-400" title="Edit"><i data-lucide="square-pen" class="w-3.5 h-3.5"></i></button>
    <button class="p-1.5 rounded-md hover:bg-gray-100 bg-transparent border-none cursor-pointer text-gray-400" title="Share"><i data-lucide="share-2" class="w-3.5 h-3.5"></i></button>
  </div>`;
}

/* ────── Case Preview Panel ────── */
function openCasePreview(caseId) {
  // Navigate to step 4 (which displays as "5 of 10")
  goToStep(4);

  // Open case preview panel
  const casePreviewPanel = document.getElementById('case-preview-panel');
  casePreviewPanel.classList.add('open');

  // Populate case preview content
  const content = document.getElementById('case-preview-content');
  content.innerHTML = generateCasePreviewHTML(caseId);

  // Re-render icons
  lucide.createIcons();
}

function closeCasePreview() {
  const panel = document.getElementById('case-preview-panel');
  panel.classList.remove('open');

  // Reset button text and styling back to "Preview document"
  const caseContainer = document.getElementById('case-2023-045-container');
  if (caseContainer) {
    const previewBtn = caseContainer.querySelector('button');
    if (previewBtn && previewBtn.textContent === 'Close preview') {
      previewBtn.textContent = 'Preview document';
      previewBtn.onclick = function() { openCasePreview('#2023-045'); };
      // Reset to outlined style
      previewBtn.style.background = 'transparent';
      previewBtn.style.border = '1px solid #004C97';
      previewBtn.style.color = '#004C97';
      previewBtn.onmouseover = function() { this.style.background='#004C97'; this.style.color='#fff'; };
      previewBtn.onmouseout = function() { this.style.background='transparent'; this.style.color='#004C97'; };
    }
  }
}

function openDraftEmailCanvas() {
  // Close case preview panel
  closeCasePreview();

  // Navigate to step 5
  goToStep(5);

  // Open canvas panel with letter content
  const canvasPanel = document.getElementById('canvas-panel');
  const canvasContent = document.getElementById('canvas-content');

  canvasContent.innerHTML = generateDraftLetterHTML();
  canvasPanel.classList.add('open');

  // Reinitialize Lucide icons
  lucide.createIcons();
}

function generateDraftLetterHTML() {
  return `
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <h2 class="text-xl font-semibold text-gray-800">Draft Response</h2>
        <span class="inline-flex items-center gap-1.5 px-2 py-1 rounded-md text-xs font-medium" style="color: #15803D;">
          <i data-lucide="cloud-upload" class="w-3.5 h-3.5"></i>
          Last saved just now
        </span>
      </div>
      <div class="flex items-center gap-2">
        <!-- Button Group -->
        <div class="inline-flex rounded-lg shadow-sm" role="group">
          <button type="button" onclick="nextStep()" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white border-none rounded-l-lg focus:z-10" style="background:linear-gradient(135deg,#004C97,#0060BF);">
            <i data-lucide="mail" class="w-4 h-4"></i>
            Send Email
          </button>
          <button type="button" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 bg-white border-t border-b border-r border-gray-200 hover:bg-gray-50 focus:z-10">
            <i data-lucide="bookmark" class="w-4 h-4"></i>
            Save Draft
          </button>
          <button type="button" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 bg-white border-t border-b border-r border-gray-200 hover:bg-gray-50 focus:z-10">
            <i data-lucide="share-2" class="w-4 h-4"></i>
            Share
          </button>
          <button type="button" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 bg-white border-t border-b border-r border-gray-200 rounded-r-lg hover:bg-gray-50 focus:z-10">
            <i data-lucide="user-check" class="w-4 h-4"></i>
            Send for review
          </button>
        </div>

        <!-- Close Button -->
        <button onclick="closeCanvas()" class="p-2 rounded-md hover:bg-gray-100 text-gray-400 hover:text-gray-600 bg-transparent border-none cursor-pointer">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
    </div>

    <div class="border-b border-gray-200 mb-6" style="margin-left: -1.5rem; margin-right: -1.5rem; margin-bottom: 8px;"></div>

    <!-- Editing Area Row (can be split into editor + citations) -->
    <div class="flex gap-0" style="margin-left: 3rem; margin-right: 3rem; margin-top: 3rem;">

      <!-- Editor Container with Shadow -->
      <div class="flex-1 bg-white rounded-lg border border-gray-200 mb-4" style="box-shadow: 0 8px 24px rgba(0,0,0,0.12);" id="editor-container">

      <!-- Email Header Section -->
      <div class="px-6 py-4" style="background: #F9FAFB; border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem;">
        <div class="space-y-2" style="font-size: 0.8rem;">
          <div class="flex items-center">
            <span class="font-medium text-gray-600" style="min-width: 4rem;">To:</span>
            <span class="text-gray-800">John Smith &lt;john.smith@imf.com&gt;</span>
          </div>
          <div class="flex items-center">
            <span class="font-medium text-gray-600" style="min-width: 4rem;">From:</span>
            <span class="text-gray-800">John Miller (HR Policy Officer)</span>
          </div>
          <div class="flex items-center">
            <span class="font-medium text-gray-600" style="min-width: 4rem;">Subject:</span>
            <span class="text-gray-800">REQ0012345: Parental leave extension request</span>
          </div>
        </div>
      </div>

      <!-- Separator -->
      <div class="border-b border-gray-200"></div>

      <!-- WYSIWYG Controls -->
      <div class="flex items-center justify-between gap-2 px-6 pb-3" style="border-bottom: 1px solid #E5E7EB; padding-top: 0.75rem;">
      <div class="flex items-center gap-2">
        <div class="relative">
          <button onclick="toggleEnhanceMenu()" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium cursor-pointer" style="background: white; border: 1px solid transparent; background-image: linear-gradient(white, white), linear-gradient(135deg, #527FFF, #AF81FF); background-origin: border-box; background-clip: padding-box, border-box; color: #1e3a8a; font-size: 0.8rem;">
            <i data-lucide="sparkles" class="w-4 h-4"></i>
            Enhance with AI
            <i data-lucide="chevron-down" class="w-3.5 h-3.5"></i>
          </button>

          <div id="enhance-menu" class="hidden absolute top-full left-0 mt-2 w-80 bg-white rounded-lg shadow-lg border border-gray-200 py-2 z-50">
            <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 bg-transparent border-none cursor-pointer">
              Adjust to comply with IMF policies
            </button>
            <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 bg-transparent border-none cursor-pointer">
              Make text shorter
            </button>
            <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 bg-transparent border-none cursor-pointer">
              Change to tone of voice to friendly
            </button>
            <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 bg-transparent border-none cursor-pointer">
              Change to tone of voice to official
            </button>
            <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 bg-transparent border-none cursor-pointer">
              Just fix the language errors
            </button>
            <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 bg-transparent border-none cursor-pointer">
              Translate to...
            </button>
          </div>
        </div>

        <div class="inline-flex items-center gap-1" role="group">
          <button type="button" class="p-2 text-gray-700 hover:bg-gray-50 cursor-pointer bg-transparent border-none">
            <i data-lucide="bold" class="w-5 h-5"></i>
          </button>
          <button type="button" class="p-2 text-gray-700 hover:bg-gray-50 cursor-pointer bg-transparent border-none">
            <i data-lucide="italic" class="w-5 h-5"></i>
          </button>
          <button type="button" class="p-2 text-gray-700 hover:bg-gray-50 cursor-pointer bg-transparent border-none">
            <i data-lucide="underline" class="w-5 h-5"></i>
          </button>

          <div class="border-l border-gray-200" style="height: 24px;"></div>

          <button type="button" class="p-2 text-gray-700 hover:bg-gray-50 cursor-pointer bg-transparent border-none inline-flex items-center gap-1">
            <i data-lucide="a-large-small" class="w-5 h-5"></i>
            <i data-lucide="chevron-down" class="w-3 h-3"></i>
          </button>
          <button type="button" class="p-2 text-gray-700 hover:bg-gray-50 cursor-pointer bg-transparent border-none inline-flex items-center gap-1">
            <i data-lucide="paint-bucket" class="w-5 h-5"></i>
            <i data-lucide="chevron-down" class="w-3 h-3"></i>
          </button>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <div class="inline-flex gap-1">
          <button type="button" class="p-2 text-gray-700 hover:bg-gray-50 cursor-pointer bg-transparent border-none rounded" title="Undo">
            <i data-lucide="undo" class="w-5 h-5"></i>
          </button>
          <button type="button" disabled class="p-2 text-gray-400 bg-transparent border-none rounded cursor-not-allowed" title="Redo">
            <i data-lucide="redo" class="w-5 h-5"></i>
          </button>
        </div>

        <div class="inline-flex rounded-lg shadow-sm" role="group">
        <button type="button" class="inline-flex items-center gap-2 px-3 py-2 text-gray-700 bg-white border border-gray-200 rounded-l-lg hover:bg-gray-50 focus:z-10" style="font-size: 0.8rem; font-weight: 400;">
          <i data-lucide="history" class="w-4 h-4"></i>
          Versions
        </button>
        <button type="button" id="citations-btn" onclick="toggleCitationsPanel()" class="inline-flex items-center gap-2 px-3 py-2 text-gray-700 bg-white border-t border-b border-r border-gray-200 hover:bg-gray-50 focus:z-10" style="font-size: 0.8rem; font-weight: 400;">
          <i data-lucide="quote" class="w-4 h-4"></i>
          Citations
        </button>
        <button type="button" class="inline-flex items-center gap-2 px-3 py-2 text-gray-700 bg-white border-t border-b border-r border-gray-200 rounded-r-lg hover:bg-gray-50 focus:z-10" style="font-size: 0.8rem; font-weight: 400;">
          <i data-lucide="book-open-check" class="w-4 h-4"></i>
          Provenance
        </button>
        </div>
      </div>
    </div>

      <div contenteditable="true" class="w-full leading-relaxed" style="font-family: inherit; min-height: 500px; outline: none; background: white; font-size: 0.9rem; padding: 2rem 3rem; border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem;">
      <p style="margin: 0 0 1em 0;">Dear John Smith,</p>

      <p style="margin: 0 0 1em 0;">I am writing to inform you of the decision regarding your request for an extension of parental leave due to medical complications <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-normal" style="background: #F3F4F6; color: #6B7280; margin-left: 2px;">Case</span>.</p>

      <p style="margin: 0 0 1em 0;">After careful review of your request and supporting medical documentation, I am pleased to inform you that your request for an <strong>8-week extension</strong> of parental leave has been <strong>approved</strong>.</p>

      <p style="margin: 0 0 1em 0;"><strong>Decision Details:</strong></p>
      <ul style="margin: 0 0 1em 0; padding-left: 1.5em;">
        <li>Extension Period: <strong>8 weeks</strong></li>
        <li>New Return Date: <strong>May 17, 2023</strong></li>
        <li>Decision Authority: HR Director (M. Chen)</li>
        <li>Decision Date: March 22, 2023</li>
      </ul>

      <p style="margin: 0 0 1em 0;">Your request meets the criteria outlined in <strong>HR Policy 4.2.3 - Parental Leave Extensions</strong> <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-normal" style="background: #F3F4F6; color: #6B7280; margin-left: 2px;">Policy</span>, specifically the provisions for medical exceptions. The medical documentation provided by Dr. Anderson <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-normal" style="background: #F3F4F6; color: #6B7280; margin-left: 2px;">Guide</span> clearly supports the need for extended recovery time.</p>

      <p style="margin: 0 0 1em 0;"><strong>Please note the following:</strong></p>
      <ul style="margin: 0 0 1em 0; padding-left: 1.5em;">
        <li>You are required to provide medical clearance before your return to work <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-normal" style="background: #F3F4F6; color: #6B7280; margin-left: 2px;">Policy</span></li>
        <li>A phased return option is available if needed upon your return</li>
        <li>HR will check in with you at the 6-week mark to discuss your transition plans</li>
      </ul>

      <p style="margin: 0 0 1em 0;">If you have any questions or concerns regarding this decision or your return to work, please do not hesitate to contact me or your HR Business Partner.</p>

      <p style="margin: 0 0 1em 0;">We wish you a smooth recovery and look forward to your return.</p>

      <hr style="border: none; border-top: 1px solid #E5E7EB; margin: 1.5em 0;">

      <p style="margin: 0 0 1em 0;">Best regards,</p>

      <p style="margin: 0; font-size: 0.75rem; color: #6B7280; line-height: 1.4;">
        <strong style="color: #374151;">John Miller</strong><br>
        HR Specialist<br>
        Human Resources Department<br>
        International Monetary Fund
      </p>
      </div>
      </div>
      <!-- End of Editor Container -->

      <!-- Citations Panel (appears on right when opened) -->
      <div id="citations-panel-inline" style="display: none; width: 340px; min-width: 340px; padding-left: 1.5rem; margin-left: 1.5rem;">
      </div>

    </div>
    <!-- End of Editing Area Row -->
  `;
}

function closeCanvas() {
  const panel = document.getElementById('canvas-panel');
  panel.classList.remove('open');

  // Also close citations panel when closing canvas
  closeCitationsPanel();
}

function toggleCitationsPanel() {
  const panel = document.getElementById('citations-panel-inline');
  const btn = document.getElementById('citations-btn');

  if (panel && panel.style.display === 'block') {
    closeCitationsPanel();
  } else {
    openCitationsPanel();
  }
}

function openCitationsPanel() {
  const panel = document.getElementById('citations-panel-inline');
  const btn = document.getElementById('citations-btn');

  if (panel) {
    panel.innerHTML = generateCitationsHTML();
    panel.style.display = 'block';

    // Set button to active state
    if (btn) {
      btn.style.backgroundColor = '#F3F4F6';
      btn.style.color = '#111827';
    }

    // Reinitialize Lucide icons
    lucide.createIcons();
  }
}

function closeCitationsPanel() {
  const panel = document.getElementById('citations-panel-inline');
  const btn = document.getElementById('citations-btn');

  if (panel) {
    panel.style.display = 'none';
    panel.innerHTML = '';
  }

  // Reset button to normal state
  if (btn) {
    btn.style.backgroundColor = 'white';
    btn.style.color = '#374151';
  }
}

function generateCitationsHTML() {
  return `
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold text-gray-900">Cited sources</h3>
      <button onclick="closeCitationsPanel()" class="p-1.5 rounded-md hover:bg-gray-100 text-gray-400 hover:text-gray-600 bg-transparent border-none cursor-pointer">
        <i data-lucide="x" class="w-4 h-4"></i>
      </button>
    </div>

    <div class="space-y-3">
      <!-- Policy Citation Card -->
      <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
        <div class="flex items-start gap-3">
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-1">
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-normal" style="background: #F3F4F6; color: #6B7280;">Policy</span>
            </div>
            <h3 class="font-semibold text-gray-800 text-sm mb-1">HR Policy 4.2.3 - Parental Leave Extensions</h3>
            <p class="text-xs text-gray-600 mb-2">IMF Human Resources Policy Manual, Section 4: Leave and Absence, Subsection 2.3</p>
            <div class="flex items-center gap-4 text-xs text-gray-500">
              <span class="flex items-center gap-1">
                <i data-lucide="calendar" class="w-3 h-3"></i>
                Updated: Jan 2023
              </span>
              <span class="flex items-center gap-1">
                <img src="icons/sharepoint.svg" class="w-3 h-3" alt="SharePoint">
                Sharepoint
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Case Citation Card #1 -->
      <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
        <div class="flex items-start gap-3">
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-1">
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-normal" style="background: #F3F4F6; color: #6B7280;">Case</span>
            </div>
            <h3 class="font-semibold text-gray-800 text-sm mb-1">Case #2023-045: Medical Extension Approval</h3>
            <p class="text-xs text-gray-600 mb-2">Parental leave extension due to postpartum complications - 8 week approval precedent</p>
            <div class="flex items-center gap-4 text-xs text-gray-500">
              <span class="flex items-center gap-1">
                <i data-lucide="calendar" class="w-3 h-3"></i>
                13 Mar 2023
              </span>
              <span class="flex items-center gap-1">
                <img src="icons/servicenow.svg" class="w-3 h-3" alt="ServiceNow">
                ServiceNow
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Medical Documentation Citation -->
      <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
        <div class="flex items-start gap-3">
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-1">
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-normal" style="background: #F3F4F6; color: #6B7280;">Guide</span>
            </div>
            <h3 class="font-semibold text-gray-800 text-sm mb-1">Medical Documentation - Dr. Anderson</h3>
            <p class="text-xs text-gray-600 mb-2">Supporting medical documentation for extended recovery period requirement</p>
            <div class="flex items-center gap-4 text-xs text-gray-500">
              <span class="flex items-center gap-1">
                <i data-lucide="calendar" class="w-3 h-3"></i>
                10 Mar 2023
              </span>
              <span class="flex items-center gap-1">
                <img src="icons/sharepoint.svg" class="w-3 h-3" alt="SharePoint">
                Sharepoint
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- HR Guidelines Citation -->
      <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
        <div class="flex items-start gap-3">
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-1">
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-normal" style="background: #F3F4F6; color: #6B7280;">Policy</span>
            </div>
            <h3 class="font-semibold text-gray-800 text-sm mb-1">Return-to-Work Guidelines</h3>
            <p class="text-xs text-gray-600 mb-2">IMF HR Guidelines for phased return and medical clearance requirements</p>
            <div class="flex items-center gap-4 text-xs text-gray-500">
              <span class="flex items-center gap-1">
                <i data-lucide="calendar" class="w-3 h-3"></i>
                Updated: Jun 2022
              </span>
              <span class="flex items-center gap-1">
                <img src="icons/confluence.svg" class="w-3 h-3" alt="Confluence">
                Confluence
              </span>
            </div>
          </div>
        </div>
      </div>

    </div>
  `;
}

function toggleEnhanceMenu() {
  const menu = document.getElementById('enhance-menu');
  menu.classList.toggle('hidden');
}

// Close the enhance menu when clicking outside
document.addEventListener('click', function(event) {
  const menu = document.getElementById('enhance-menu');
  const button = event.target.closest('button[onclick="toggleEnhanceMenu()"]');

  if (menu && !menu.classList.contains('hidden') && !button && !menu.contains(event.target)) {
    menu.classList.add('hidden');
  }
});

function generateCasePreviewHTML(caseId) {
  return `
    <div class="fade-in">
      <!-- Header with Button Group and Close button -->
      <div class="flex items-center justify-between mb-6 w-full">
        <h2 class="text-xl font-semibold text-gray-800 flex-shrink-0">Case ID: ${caseId}</h2>
        <div class="flex items-center gap-2 flex-shrink-0">
          <!-- Button Group -->
          <div class="inline-flex rounded-lg shadow-sm" role="group">
            <button type="button" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-l-lg hover:bg-gray-50 focus:z-10">
              Open in ServiceNow
              <i data-lucide="external-link" class="w-4 h-4"></i>
            </button>
            <button type="button" class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border-t border-b border-r border-gray-200 hover:bg-gray-50 focus:z-10" title="Copy Reference Number (${caseId})">
              <i data-lucide="hash" class="w-4 h-4"></i>
            </button>
            <button type="button" class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border-t border-b border-r border-gray-200 hover:bg-gray-50 focus:z-10" title="Copy Case Summary">
              <i data-lucide="copy" class="w-4 h-4"></i>
            </button>
            <button type="button" class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border-t border-b border-r border-gray-200 hover:bg-gray-50 focus:z-10" title="Share the Case">
              <i data-lucide="share-2" class="w-4 h-4"></i>
            </button>
            <button type="button" class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-r-lg hover:bg-gray-50 focus:z-10" title="Save to Knowledge Base">
              <i data-lucide="bookmark" class="w-4 h-4"></i>
            </button>
          </div>
          <button onclick="closeCasePreview()" class="p-2 rounded-md hover:bg-gray-100 text-gray-400 hover:text-gray-600 bg-transparent border-none cursor-pointer">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
      </div>

      <!-- Section 2: Case Info -->
      <div class="bg-white border border-gray-200 rounded-lg p-4 mb-4">
        <div class="grid grid-cols-2" style="font-size: 0.8rem; gap: 0.4rem;">
          <div><span style="color: #6B7785;">Date Created:</span> <span class="text-gray-800">March 15, 2023</span></div>
          <div><span style="color: #6B7785;">Date Resolved:</span> <span class="text-gray-800">March 22, 2023</span></div>
          <div><span style="color: #6B7785;">Category:</span> <span class="tag" style="background:rgba(107,114,128,0.1); color:#686E7D; font-size: 0.8rem;">Leave & Absence</span></div>
          <div><span style="color: #6B7785;">Jurisdiction:</span> <span class="tag" style="background:rgba(107,114,128,0.1); color:#686E7D; font-size: 0.8rem;">Human Resources Department</span></div>
          <div><span style="color: #6B7785;">Status:</span> <span class="tag" style="background:rgba(52,211,153,0.2); color:#059669; font-size: 0.8rem;">Resolved</span></div>
          <div><span style="color: #6B7785;">Priority:</span> <span class="text-gray-800">Medium</span></div>
          <div class="col-span-2 flex items-center">
            <span style="color: #6B7785;">Assigned To:&nbsp;</span>
            <a href="#" class="hover:underline inline-flex items-center gap-1" style="color: #004C97;">
              Sarah Johnson (HR Specialist)
              <i data-lucide="external-link" class="w-3 h-3"></i>
            </a>
            <button class="hover:bg-gray-100 rounded bg-transparent border-none cursor-pointer text-gray-500 ml-1 inline-flex items-center" style="width: 20px; height: 20px; padding: 2px;">
              <i data-lucide="ellipsis-vertical" class="w-4 h-4"></i>
            </button>
          </div>
          <div class="col-span-2 flex items-center">
            <span style="color: #6B7785;">Approved By:&nbsp;</span>
            <a href="#" class="hover:underline inline-flex items-center gap-1" style="color: #004C97;">
              Michael Chen (HR Director)
              <i data-lucide="external-link" class="w-3 h-3"></i>
            </a>
            <button class="hover:bg-gray-100 rounded bg-transparent border-none cursor-pointer text-gray-500 ml-1 inline-flex items-center" style="width: 20px; height: 20px; padding: 2px;">
              <i data-lucide="ellipsis-vertical" class="w-4 h-4"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Auto-suggestions -->
      <div class="flex gap-3 mb-4">
        <button onclick="openDraftEmailCanvas()" class="act-btn flex flex-col items-start gap-2 px-4 py-3 rounded-xl cursor-pointer transition-all" style="background: linear-gradient(135deg, rgba(167, 139, 250, 0.08) 0%, rgba(139, 192, 246, 0.08) 100%); border: 1px solid rgba(167, 139, 250, 0.2); box-shadow: 0 2px 8px rgba(0,0,0,.04); flex: 1;">
          <img src="icons/pen-sparkle.svg" class="w-5 h-5 flex-shrink-0" alt="" />
          <span class="text-left" style="font-size: 0.9rem; line-height: 1.25rem; font-weight: 600; color: #374151;">Generate a draft response email based on this case</span>
        </button>
        <button onclick="fillPrompt('Generate a draft request to retrieve medical documents')" class="act-btn flex flex-col items-start gap-2 px-4 py-3 rounded-xl cursor-pointer transition-all" style="background: linear-gradient(135deg, rgba(167, 139, 250, 0.08) 0%, rgba(139, 192, 246, 0.08) 100%); border: 1px solid rgba(167, 139, 250, 0.2); box-shadow: 0 2px 8px rgba(0,0,0,.04); flex: 1;">
          <img src="icons/pen-sparkle.svg" class="w-5 h-5 flex-shrink-0" alt="" />
          <span class="text-left" style="font-size: 0.9rem; line-height: 1.25rem; font-weight: 600; color: #374151;">Generate a draft request to retrieve medical documents</span>
        </button>
      </div>

      <!-- Section 3: Employee Information -->
      <div class="bg-white border border-gray-200 rounded-lg p-4 mb-4">
        <h3 class="text-sm font-semibold text-gray-700 mb-3 pb-3 border-b border-gray-200">Employee Information</h3>
        <div class="grid grid-cols-2" style="font-size: 0.8rem; gap: 0.4rem;">
          <div><span style="color: #6B7785;">Name:</span> <span class="text-gray-800">[Redacted for privacy]</span></div>
          <div><span style="color: #6B7785;">Department:</span> <span class="text-gray-800">Finance</span></div>
          <div><span style="color: #6B7785;">Grade:</span> <span class="text-gray-800">A14</span></div>
          <div><span style="color: #6B7785;">Years of Service:</span> <span class="text-gray-800">6 years</span></div>
          <div class="col-span-2"><span style="color: #6B7785;">Employment Status:</span> <span class="text-gray-800">Regular Staff</span></div>
        </div>
      </div>

      <!-- Section 4: Request Details -->
      <div class="bg-white border border-gray-200 rounded-lg p-4 mb-4">
        <h3 class="text-sm font-semibold text-gray-700 mb-3 pb-3 border-b border-gray-200">Request Details</h3>
        <div class="grid grid-cols-2 mb-3" style="font-size: 0.8rem; gap: 0.4rem;">
          <div><span style="color: #6B7785;">Request Type:</span> <span class="text-gray-800">Parental Leave Extension</span></div>
          <div><span style="color: #6B7785;">Standard Leave Taken:</span> <span class="text-gray-800">16 weeks</span></div>
          <div><span style="color: #6B7785;">Extension Requested:</span> <span class="text-gray-800">8 additional weeks</span></div>
          <div><span style="color: #6B7785;">Total Leave:</span> <span class="text-gray-800 font-medium">24 weeks</span></div>
        </div>
        <div class="mt-3 border-t border-gray-200" style="padding-top: 1rem;">
          <p class="font-semibold text-gray-500 uppercase mb-2" style="font-size: 0.7rem; letter-spacing: 0.05rem;">Reason for Extension</p>
          <p class="text-gray-800 leading-relaxed" style="font-size: 0.875rem;">Medical complications following childbirth requiring extended recovery period. Employee provided medical certification from attending physician documenting postpartum complications and recommended recovery timeline.</p>
        </div>
        <div class="mt-3 border-t border-gray-200" style="padding-top: 1rem;">
          <p class="font-semibold text-gray-500 uppercase mb-2" style="font-size: 0.7rem; letter-spacing: 0.05rem;">Supporting Documents</p>
          <ul class="space-y-2" style="font-size: 0.8rem; list-style-type: disc; padding-left: 0.8rem;">
            <li>
              <a href="#" class="hover:underline inline-flex items-center gap-1" style="color: #004C97;">
                Medical Certificate (Dr. Anderson, 03/10/23)
                <i data-lucide="arrow-down-to-line" class="w-3 h-3"></i>
              </a>
            </li>
            <li>
              <a href="#" class="hover:underline inline-flex items-center gap-1" style="color: #004C97;">
                Leave Request Form (Submitted 03/12/23)
                <i data-lucide="external-link" class="w-3 h-3"></i>
              </a>
            </li>
            <li>
              <a href="#" class="hover:underline inline-flex items-center gap-1" style="color: #004C97;">
                Supervisor Recommendation (Finance Dept Head)
                <i data-lucide="arrow-down-to-line" class="w-3 h-3"></i>
              </a>
            </li>
            <li>
              <a href="#" class="hover:underline inline-flex items-center gap-1" style="color: #004C97;">
                HR Policy Review Notes
                <i data-lucide="external-link" class="w-3 h-3"></i>
              </a>
            </li>
          </ul>
        </div>
      </div>

      <!-- Section 6: Compliance -->
      <div class="bg-white border border-gray-200 rounded-lg p-4 mb-4">
        <h3 class="text-sm font-semibold text-gray-700 mb-3 pb-3 border-b border-gray-200">Compliance</h3>
        <p class="font-semibold text-gray-500 uppercase mb-2" style="font-size: 0.7rem; letter-spacing: 0.05rem;">Cited Policies</p>
        <div class="space-y-2 mb-4">
          <a href="#" class="flex items-center gap-2 p-2 rounded-lg border border-gray-200 hover:bg-gray-50 transition-colors" style="font-size: 0.8rem; text-decoration: none; color: #004C97;">
            <i data-lucide="book-check" class="w-4 h-4 flex-shrink-0"></i>
            <span>HR Policy 4.2.3 - Parental Leave Extensions</span>
          </a>
          <a href="#" class="flex items-center gap-2 p-2 rounded-lg border border-gray-200 hover:bg-gray-50 transition-colors" style="font-size: 0.8rem; text-decoration: none; color: #004C97;">
            <i data-lucide="book-check" class="w-4 h-4 flex-shrink-0"></i>
            <span>HR Guidelines Section 8.1 - Medical Exceptions</span>
          </a>
          <a href="#" class="flex items-center gap-2 p-2 rounded-lg border border-gray-200 hover:bg-gray-50 transition-colors" style="font-size: 0.8rem; text-decoration: none; color: #004C97;">
            <i data-lucide="book-check" class="w-4 h-4 flex-shrink-0"></i>
            <span>Staff Rules Article XII - Leave Provisions</span>
          </a>
        </div>
        <div class="mt-3 border-t border-gray-200" style="padding-top: 1rem;">
          <p class="font-semibold text-gray-500 uppercase mb-2" style="font-size: 0.7rem; letter-spacing: 0.05rem;">Related Cases Reviewed</p>
          <div class="space-y-2">
            <a href="#" class="flex items-center gap-2 p-2 rounded-lg border border-gray-200 hover:bg-gray-50 transition-colors" style="font-size: 0.8rem; text-decoration: none; color: #004C97;">
              <i data-lucide="history" class="w-4 h-4 flex-shrink-0"></i>
              <div class="flex items-center justify-between flex-1">
                <span class="font-medium">Case #2022-128</span>
                <span class="text-green-600 text-xs">Similar - 8 weeks approved</span>
              </div>
            </a>
            <a href="#" class="flex items-center gap-2 p-2 rounded-lg border border-gray-200 hover:bg-gray-50 transition-colors" style="font-size: 0.8rem; text-decoration: none; color: #004C97;">
              <i data-lucide="history" class="w-4 h-4 flex-shrink-0"></i>
              <div class="flex items-center justify-between flex-1">
                <span class="font-medium">Case #2021-095</span>
                <span class="text-green-600 text-xs">Similar - 6 weeks approved</span>
              </div>
            </a>
            <a href="#" class="flex items-center gap-2 p-2 rounded-lg border border-gray-200 hover:bg-gray-50 transition-colors" style="font-size: 0.8rem; text-decoration: none; color: #004C97;">
              <i data-lucide="history" class="w-4 h-4 flex-shrink-0"></i>
              <div class="flex items-center justify-between flex-1">
                <span class="font-medium">Case #2023-012</span>
                <span class="text-gray-500 text-xs">Different circumstances</span>
              </div>
            </a>
          </div>
        </div>
      </div>

      <!-- Section 7: Audit Trail -->
      <div class="bg-white border border-gray-200 rounded-lg p-4 mb-4">
        <h3 class="text-sm font-semibold text-gray-700 mb-3 pb-3 border-b border-gray-200">Audit Trail</h3>

        <div class="space-y-3" style="font-size: 0.8rem;">
          <div class="flex gap-3">
            <div class="flex-shrink-0 text-gray-500" style="width: 6rem;">Mar 15, 2023</div>
            <div class="flex-1">
              <div class="font-medium text-gray-800 mb-1">Case Created</div>
              <div class="text-gray-600">Request submitted by employee via ServiceNow portal</div>
            </div>
          </div>

          <div class="flex gap-3">
            <div class="flex-shrink-0 text-gray-500" style="width: 6rem;">Mar 16, 2023</div>
            <div class="flex-1">
              <div class="font-medium text-gray-800 mb-1">Document Review</div>
              <div class="text-gray-600">Medical documentation verified by HR Specialist (S. Johnson)</div>
            </div>
          </div>

          <div class="flex gap-3">
            <div class="flex-shrink-0 text-gray-500" style="width: 6rem;">Mar 18, 2023</div>
            <div class="flex-1">
              <div class="font-medium text-gray-800 mb-1">Policy Compliance Check</div>
              <div class="space-y-1 mt-2">
                <div class="flex items-center gap-2">
                  <i data-lucide="circle-check-big" class="w-3.5 h-3.5 text-green-600"></i>
                  <span class="text-gray-700">Medical documentation provided</span>
                </div>
                <div class="flex items-center gap-2">
                  <i data-lucide="circle-check-big" class="w-3.5 h-3.5 text-green-600"></i>
                  <span class="text-gray-700">Within 24-week maximum allowance</span>
                </div>
                <div class="flex items-center gap-2">
                  <i data-lucide="circle-check-big" class="w-3.5 h-3.5 text-green-600"></i>
                  <span class="text-gray-700">Supervisor approval obtained</span>
                </div>
                <div class="flex items-center gap-2">
                  <i data-lucide="circle-check-big" class="w-3.5 h-3.5 text-green-600"></i>
                  <span class="text-gray-700">No operational conflicts identified</span>
                </div>
              </div>
            </div>
          </div>

          <div class="flex gap-3">
            <div class="flex-shrink-0 text-gray-500" style="width: 6rem;">Mar 20, 2023</div>
            <div class="flex-1">
              <div class="font-medium text-gray-800 mb-1">Precedent Analysis</div>
              <div class="text-gray-600">Similar cases reviewed (#2022-128, #2021-095)</div>
            </div>
          </div>

          <div class="flex gap-3">
            <div class="flex-shrink-0 text-gray-500" style="width: 6rem;">Mar 21, 2023</div>
            <div class="flex-1">
              <div class="font-medium text-gray-800 mb-1">HR Analysis (S. Johnson)</div>
              <div class="text-gray-600 italic">"Request meets all criteria for medical exception under HR Policy 4.2.3. Medical documentation is comprehensive and from qualified physician. Similar cases (#2022-128, #2021-095) were approved under comparable circumstances. Recommend approval for 8-week extension."</div>
            </div>
          </div>

          <div class="flex gap-3">
            <div class="flex-shrink-0 text-gray-500" style="width: 6rem;">Mar 22, 2023</div>
            <div class="flex-1">
              <div class="font-medium text-gray-800 mb-1">Decision Approved</div>
              <div class="text-gray-600">Extension approved by HR Director (M. Chen)</div>
            </div>
          </div>

          <div class="flex gap-3">
            <div class="flex-shrink-0 text-gray-500" style="width: 6rem;">Mar 23, 2023</div>
            <div class="flex-1">
              <div class="font-medium text-gray-800 mb-1">Employee Notified</div>
              <div class="text-gray-600">Formal notification sent via email and official letter</div>
            </div>
          </div>

          <div class="flex gap-3">
            <div class="flex-shrink-0 text-gray-500" style="width: 6rem;">Mar 24, 2023</div>
            <div class="flex-1">
              <div class="font-medium text-gray-800 mb-1">Case Closed</div>
              <div class="text-gray-600">Automatically resolved and archived by system</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Section 12: Tags -->
      <div class="flex flex-wrap gap-2 mb-4">
        <span class="tag" style="background:#F3F4F6; color:#686E7D; font-size: 12px;">Parental Leave</span>
        <span class="tag" style="background:#F3F4F6; color:#686E7D; font-size: 12px;">Medical Exception</span>
        <span class="tag" style="background:#F3F4F6; color:#686E7D; font-size: 12px;">Leave Extension</span>
        <span class="tag" style="background:#F3F4F6; color:#686E7D; font-size: 12px;">Policy 4.2.3</span>
        <span class="tag" style="background:#F3F4F6; color:#686E7D; font-size: 12px;">Approved</span>
        <span class="tag" style="background:#F3F4F6; color:#686E7D; font-size: 12px;">Precedent</span>
      </div>

      <!-- Section 14: Note -->
      <div class="bg-amber-50 border border-amber-200 rounded-lg p-3" style="font-size: 11px;">
        <p class="text-amber-800"><span class="font-medium">⚠️ Note:</span> Case details are read-only for reference purposes. To modify case records, please use ServiceNow directly.</p>
      </div>
    </div>
  `;
}

function caseCard(id, star, date, dept, ext, justification, outcome, dm) {
  return `<div class="rich-card p-4 mb-3">
    <div class="flex items-start justify-between mb-2">
      <div class="flex items-center gap-2"><span class="tag" style="background:#EBF3FE; color:#004C97;">Case</span>${star ? '<span class="tag flex items-center gap-1" style="background:linear-gradient(135deg, #0EA5E9 0%, #10B981 100%); color:#fff;"><i data-lucide="sparkles" class="w-3 h-3"></i> Most Relevant</span>' : ''}</div>
      <span class="text-xs text-gray-400">${date}</span>
    </div>
    <h4 class="text-sm font-semibold text-gray-800 mb-2">Case ${id}</h4>
    <div class="grid grid-cols-2 gap-x-4 text-gray-600 mb-3" style="font-size: 0.8rem; row-gap: 0.2rem;">
      <div class="col-span-2"><span style="color: #6B7785;">Justification:</span> ${justification}</div>
      <div><span style="color: #6B7785;">Department:</span> ${dept}</div>
      <div><span style="color: #6B7785;">Extension:</span> ${ext}</div>
      <div><span style="color: #6B7785;">Decision Maker:</span> ${dm}</div>
      <div><span style="color: #6B7785;">Outcome:</span> <span class="font-medium" style="color:${outcome==='Approved'?'#059669':'#DC2626'}">${outcome}</span></div>
    </div>
    <div class="flex flex-wrap items-center" style="font-size: 0.8rem; gap: 0.8rem;">
      <button onclick="openCasePreview('${id}')" class="font-medium px-3 py-1.5 rounded-md bg-transparent cursor-pointer transition-colors" style="border: 1px solid #004C97; color: #004C97;" onmouseover="this.style.background='#004C97'; this.style.color='#fff';" onmouseout="this.style.background='transparent'; this.style.color='#004C97';">Preview document</button>
      <button class="font-medium hover:underline bg-transparent border-none cursor-pointer p-0" style="color: #004C97;">Open case ↗</button>
      <span class="text-gray-300">|</span>
      <button class="font-medium hover:underline bg-transparent border-none cursor-pointer p-0" style="color: #004C97;">Copy Reference</button>
      <span class="text-gray-300">|</span>
      <button class="font-medium hover:underline bg-transparent border-none cursor-pointer p-0 inline-flex items-center gap-1" style="color: #004C97;">
        <i data-lucide="sparkles" class="w-3.5 h-3.5"></i>
        Use as Template
      </button>
    </div>
  </div>`;
}

/* ────── Steps content ────── */
function renderUpToStep(step) {
  const m = document.getElementById('messages');
  let html = '';

  // Step 0: Empty chat with prompt cards
  html += `<div class="text-center pt-0 pb-4 fade-in" style="position: relative;">
    <video autoplay loop muted playsinline style="position: absolute; width: 160px; height: 160px; object-fit: contain; top: 0; left: 50%; transform: translateX(-50%); z-index: 0; pointer-events: none; opacity: 0.6;">
      <source src="icons/ai-bg-shade.mp4" type="video/mp4">
      Your browser does not support the video tag.
    </video>
    <div class="relative inline-block mx-auto" style="width: 160px; height: 160px; z-index: 1; margin-bottom: -1rem;">
      <video autoplay loop muted playsinline class="w-20 h-20 rounded-full" style="object-fit: cover; display: block; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
        <source src="icons/ai-char-white.mp4" type="video/mp4">
        <source src="icons/ai-char-white.mov" type="video/quicktime">
        Your browser does not support the video tag.
      </video>
      <div class="absolute inset-0 flex items-center justify-center" style="pointer-events: none; z-index: 2;">
        <i data-lucide="sparkles" class="w-8 h-8" style="color:#fff;"></i>
      </div>
    </div>
    <h2 class="font-semibold text-gray-800 mb-1" style="font-size: 1.7rem; position: relative; z-index: 1;">Hi John, how can I help you today?</h2>
  </div>`;
  html += promptCards();

  // Render the content
  m.innerHTML = html;
  lucide.createIcons();
}

function updateScrollGradient() {
  const feed = document.getElementById('chat-feed');
  const gradient = document.getElementById('scroll-gradient');

  if (!feed || !gradient) return;

  // Check if scrolled to bottom
  const isAtBottom = feed.scrollHeight - feed.scrollTop <= feed.clientHeight + 10;

  // Show gradient if not at bottom
  if (isAtBottom) {
    gradient.style.opacity = '0';
  } else {
    gradient.style.opacity = '1';
  }
}

// Add scroll listener to chat feed
document.addEventListener('DOMContentLoaded', function() {
  const feed = document.getElementById('chat-feed');
  if (feed) {
    feed.addEventListener('scroll', updateScrollGradient);
  }
});

/* ────── Accordion Animation ────── */
function startAccordionAnimation() {
  const container = document.getElementById('accordion-container');
  if (!container) return;

  const accordionData = [
    {
      title: 'Analyzing query intent',
      items: [
        '<div class="text-gray-700"><span class="text-gray-500">Detected:</span> Precedent search for policy exception</div>',
        '<div class="text-gray-700"><span class="text-gray-500">Topic:</span> Parental leave extensions</div>',
        '<div class="text-gray-700"><span class="text-gray-500">Context:</span> Medical circumstances</div>',
        '<div class="text-gray-700"><span class="text-gray-500">Classification:</span> Policy interpretation + Exception request</div>'
      ]
    },
    {
      title: 'Searching connected systems',
      items: [
        '<div class="text-gray-700">Querying SharePoint HR Policy repository... <span class="text-green-600">✓ 847 documents scanned</span></div>',
        '<div class="text-gray-700">Searching Nexus case files... <span class="text-green-600">✓ 1,243 cases reviewed</span></div>',
        '<div class="text-gray-700">Accessing ServiceNow historical tickets... <span class="text-green-600">✓ 392 relevant tickets found</span></div>',
        '<div class="text-gray-700">Checking PeopleSoft employee records... <span class="text-green-600">✓ 67 similar cases identified</span></div>'
      ]
    },
    {
      title: 'Applying semantic filters',
      items: [
        '<div class="text-gray-700"><span class="text-gray-500">Filtering for:</span> "parental leave" + "medical extension" + "precedent"</div>',
        '<div class="text-gray-700"><span class="text-gray-500">Excluding:</span> Standard duration cases, routine approvals</div>',
        '<div class="text-gray-700"><span class="text-gray-500">Prioritizing:</span> Exception approvals, medical complications, policy interpretations</div>',
        '<div class="text-gray-700"><span class="text-gray-500">Time range:</span> Last 7 years of precedents</div>'
      ]
    },
    {
      title: 'Mining relevant precedents',
      items: [
        '<div>Found 23 relevant cases with medical extensions</div>',
        '<div>Analyzing approval patterns and rationale</div>',
        '<div>Extracting policy citations and decision criteria</div>',
        '<div>Identifying similar circumstances and outcomes</div>'
      ]
    },
    {
      title: 'Generating response',
      items: [
        '<div>Structuring precedent summary</div>',
        '<div>Adding source citations from: HR Policy Manual Section 4.2, ServiceNow Cases, Nexus Documents</div>',
        '<div>Confidence level: High (89%)</div>',
        '<div>Response ready for review</div>'
      ]
    }
  ];

  let currentAccordionIndex = 0;

  function showNextAccordion() {
    if (currentAccordionIndex >= accordionData.length) {
      // All accordions done, show "Analysis complete"
      setTimeout(() => {
        const completeMsg = document.createElement('div');
        completeMsg.className = 'flex items-center gap-1.5 text-xs text-green-600';
        completeMsg.style.marginTop = '1rem';
        completeMsg.style.opacity = '0';
        completeMsg.style.transition = 'opacity 0.3s ease';
        completeMsg.innerHTML = `
          <i data-lucide="check-circle" class="w-3.5 h-3.5"></i>
          <span>Analysis complete (10.2 seconds)</span>
        `;
        container.appendChild(completeMsg);
        lucide.createIcons();
        setTimeout(() => { completeMsg.style.opacity = '1'; }, 50);

        // Automatically move to step 3 after showing completion message, but only if still on step 2
        setTimeout(() => {
          if (currentStep === 2) {
            goToStep(3);
          }
        }, 1500);
      }, 300);
      return;
    }

    const data = accordionData[currentAccordionIndex];
    const accordionId = `accordion-${currentAccordionIndex}`;

    // Create accordion element
    const details = document.createElement('details');
    details.className = 'group';
    details.id = accordionId;
    details.open = true;
    details.style.opacity = '0';
    details.style.transition = 'opacity 0.3s ease';

    details.innerHTML = `
      <summary class="flex items-center gap-2 cursor-pointer text-sm text-gray-600 hover:text-gray-800 list-none">
        <i data-lucide="chevron-right" class="w-3.5 h-3.5 transition-transform group-open:rotate-90"></i>
        <span>${data.title}</span>
      </summary>
      <div class="mt-2 p-3 rounded-lg space-y-2 text-sm accordion-content" style="background: #F9FAFB; border: 1px solid #E5E7EB;">
        <!-- Items will be added here -->
      </div>
    `;

    container.appendChild(details);
    lucide.createIcons();

    // Fade in accordion
    setTimeout(() => { details.style.opacity = '1'; }, 50);

    // Animate items one by one
    const contentDiv = details.querySelector('.accordion-content');
    let itemIndex = 0;

    function showNextItem() {
      if (itemIndex >= data.items.length) {
        // All items shown, close accordion and move to next
        setTimeout(() => {
          details.open = false;
          currentAccordionIndex++;
          showNextAccordion();
        }, 500);
        return;
      }

      const itemDiv = document.createElement('div');
      itemDiv.innerHTML = data.items[itemIndex];
      itemDiv.style.opacity = '0';
      itemDiv.style.transition = 'opacity 0.2s ease';
      contentDiv.appendChild(itemDiv);

      setTimeout(() => { itemDiv.style.opacity = '1'; }, 50);

      itemIndex++;
      setTimeout(showNextItem, 600); // Show next item after 600ms
    }

    // Start showing items after accordion appears
    setTimeout(showNextItem, 400);
  }

  // Start the animation
  showNextAccordion();
}

/* ────── Search Interface ────── */
function openSearchExplore() {
  // Update active nav states
  const navLinks = document.querySelectorAll('.nav-link');
  navLinks.forEach(link => link.classList.remove('active'));
  document.getElementById('search-explore-link').classList.add('active');

  // Open canvas panel with search interface
  const canvasPanel = document.getElementById('canvas-panel');
  const canvasContent = document.getElementById('canvas-content');
  if (canvasPanel && canvasContent) {
    canvasContent.innerHTML = generateSearchInterfaceHTML();
    canvasPanel.classList.add('open');
    lucide.createIcons();
  }
}

function generateSearchInterfaceHTML() {
  return `
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <h2 class="text-xl font-semibold text-gray-800">Document Search & Repository</h2>
      </div>
      <div class="flex items-center gap-2">
        <div class="inline-flex rounded-lg shadow-sm" role="group">
          <button type="button" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white border-none focus:z-10" style="background:linear-gradient(135deg,#004C97,#0060BF); border-top-left-radius: 0.5rem; border-bottom-left-radius: 0.5rem;">
            <i data-lucide="download" class="w-4 h-4"></i>
            Export Results
          </button>
          <button type="button" class="inline-flex items-center px-2 py-2 text-sm font-medium text-white border-none focus:z-10" style="background:linear-gradient(135deg,#004C97,#0060BF); border-left: 1px solid rgba(255,255,255,0.2);">
            <i data-lucide="chevron-down" class="w-4 h-4"></i>
          </button>
          <button type="button" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 bg-white border-t border-b border-r border-gray-200 hover:bg-gray-50 focus:z-10">
            <i data-lucide="bookmark" class="w-4 h-4"></i>
            Save Search
          </button>
          <button type="button" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 bg-white border-t border-b border-r border-gray-200 rounded-r-lg hover:bg-gray-50 focus:z-10">
            <i data-lucide="share-2" class="w-4 h-4"></i>
            Share
          </button>
        </div>
        <button onclick="closeCanvas()" class="p-2 rounded-md hover:bg-gray-100 text-gray-400 hover:text-gray-600 bg-transparent border-none cursor-pointer">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
    </div>

    <!-- Search and Filters Combined -->
    <div class="flex items-center gap-0 mb-6 border border-gray-300 rounded-lg overflow-hidden">
      <!-- Search Input -->
      <div class="relative flex-1">
        <i data-lucide="search" class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2"></i>
        <input type="text" placeholder="Search documents, policies, reports..." class="w-full pl-10 pr-4 py-3 border-none focus:outline-none focus:ring-0" style="background: white;" />
      </div>

      <!-- Document Type Filter -->
      <div class="relative border-l border-gray-300">
        <select class="appearance-none px-3 py-3 pr-8 text-sm border-none bg-white cursor-pointer hover:bg-gray-50 focus:outline-none focus:ring-0" style="height: 100%;">
          <option selected>Document Type: All</option>
          <option>Surveillance Reports</option>
          <option>Lending Agreements</option>
          <option>Policy Documents</option>
          <option>Templates</option>
        </select>
        <i data-lucide="chevron-down" class="w-4 h-4 text-gray-400 absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none"></i>
      </div>

      <!-- Region Filter -->
      <div class="relative border-l border-gray-300">
        <select class="appearance-none px-3 py-3 pr-8 text-sm border-none bg-white cursor-pointer hover:bg-gray-50 focus:outline-none focus:ring-0" style="height: 100%;">
          <option selected>Region: All</option>
          <option>Africa</option>
          <option>Asia-Pacific</option>
          <option>Europe</option>
          <option>Latin America</option>
          <option>Middle East</option>
        </select>
        <i data-lucide="chevron-down" class="w-4 h-4 text-gray-400 absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none"></i>
      </div>

      <!-- Date Range Filter -->
      <div class="relative border-l border-gray-300">
        <select class="appearance-none px-3 py-3 pr-8 text-sm border-none bg-white cursor-pointer hover:bg-gray-50 focus:outline-none focus:ring-0" style="height: 100%;">
          <option>Date Range: All</option>
          <option>Last 30 days</option>
          <option selected>Last 6 months</option>
          <option>Last year</option>
          <option>Custom range</option>
        </select>
        <i data-lucide="chevron-down" class="w-4 h-4 text-gray-400 absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none"></i>
      </div>

      <!-- Status Filter -->
      <div class="relative border-l border-gray-300">
        <select class="appearance-none px-3 py-3 pr-8 text-sm border-none bg-white cursor-pointer hover:bg-gray-50 focus:outline-none focus:ring-0" style="height: 100%;">
          <option selected>Status: Draft, Under Review</option>
          <option>Draft</option>
          <option>Under Review</option>
          <option>Approved</option>
          <option>Archived</option>
          <option>All Statuses</option>
        </select>
        <i data-lucide="chevron-down" class="w-4 h-4 text-gray-400 absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none"></i>
      </div>
    </div>

    <div class="border-b border-gray-200 mb-6" style="margin-left: -1.5rem; margin-right: -1.5rem;"></div>

    <div>
      <!-- Documents List -->
      <div>
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-semibold text-gray-700">Documents (1,247)</h3>
          <select class="text-xs border border-gray-300 rounded px-2 py-1">
            <option>Sort by: Most Recent</option>
            <option>Sort by: Relevance</option>
            <option>Sort by: Title</option>
          </select>
        </div>

        <div class="space-y-3">
          <!-- Document Card 1 -->
          <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
            <div class="flex items-start gap-3">
              <i data-lucide="file-text" class="w-5 h-5 text-imf-blue flex-shrink-0 mt-0.5"></i>
              <div class="flex-1">
                <h4 class="font-medium text-gray-800 text-sm mb-1">Article IV Consultation - Kenya 2024</h4>
                <p class="text-xs text-gray-600 mb-2">Comprehensive surveillance report covering economic developments and policy recommendations</p>
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs" style="background: #EBF3FE; color: #004C97;">Surveillance Report</span>
                  <span class="text-xs text-gray-500">Africa</span>
                  <span class="text-xs text-gray-500">•</span>
                  <span class="text-xs text-gray-500">Updated Feb 8, 2024</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Document Card 2 -->
          <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
            <div class="flex items-start gap-3">
              <i data-lucide="file-text" class="w-5 h-5 text-imf-blue flex-shrink-0 mt-0.5"></i>
              <div class="flex-1">
                <h4 class="font-medium text-gray-800 text-sm mb-1">Extended Credit Facility - Bangladesh</h4>
                <p class="text-xs text-gray-600 mb-2">Lending arrangement documentation and conditionality framework</p>
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs" style="background: #FEF3E2; color: #D97706;">Lending Agreement</span>
                  <span class="text-xs text-gray-500">Asia-Pacific</span>
                  <span class="text-xs text-gray-500">•</span>
                  <span class="text-xs text-gray-500">Updated Feb 5, 2024</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Document Card 3 -->
          <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
            <div class="flex items-start gap-3">
              <i data-lucide="file-text" class="w-5 h-5 text-imf-blue flex-shrink-0 mt-0.5"></i>
              <div class="flex-1">
                <h4 class="font-medium text-gray-800 text-sm mb-1">Policy Support Instrument - Morocco</h4>
                <p class="text-xs text-gray-600 mb-2">Non-financial instrument supporting economic reforms and policy objectives</p>
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs" style="background: #F3F4F6; color: #6B7280;">Policy Document</span>
                  <span class="text-xs text-gray-500">Middle East</span>
                  <span class="text-xs text-gray-500">•</span>
                  <span class="text-xs text-gray-500">Updated Jan 28, 2024</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Document Card 4 -->
          <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
            <div class="flex items-start gap-3">
              <i data-lucide="file-text" class="w-5 h-5 text-imf-blue flex-shrink-0 mt-0.5"></i>
              <div class="flex-1">
                <h4 class="font-medium text-gray-800 text-sm mb-1">Rapid Financing Instrument - Ecuador</h4>
                <p class="text-xs text-gray-600 mb-2">Emergency financing documentation for urgent balance of payments needs</p>
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs" style="background: #FEE2E2; color: #DC2626;">Emergency Lending</span>
                  <span class="text-xs text-gray-500">Latin America</span>
                  <span class="text-xs text-gray-500">•</span>
                  <span class="text-xs text-gray-500">Updated Jan 15, 2024</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Document Card 5 -->
          <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
            <div class="flex items-start gap-3">
              <i data-lucide="file-text" class="w-5 h-5 text-imf-blue flex-shrink-0 mt-0.5"></i>
              <div class="flex-1">
                <h4 class="font-medium text-gray-800 text-sm mb-1">Staff Report Template - Article IV</h4>
                <p class="text-xs text-gray-600 mb-2">Standard template for bilateral surveillance mission reports</p>
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs" style="background: #F0FDF4; color: #16A34A;">Template</span>
                  <span class="text-xs text-gray-500">Global</span>
                  <span class="text-xs text-gray-500">•</span>
                  <span class="text-xs text-gray-500">Updated Dec 20, 2023</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Document Card 6 -->
          <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
            <div class="flex items-start gap-3">
              <i data-lucide="file-text" class="w-5 h-5 text-imf-blue flex-shrink-0 mt-0.5"></i>
              <div class="flex-1">
                <h4 class="font-medium text-gray-800 text-sm mb-1">Stand-By Arrangement - Argentina 2024</h4>
                <p class="text-xs text-gray-600 mb-2">Financial support program with quarterly review conditions</p>
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs" style="background: #FEF3E2; color: #D97706;">Lending Agreement</span>
                  <span class="text-xs text-gray-500">Latin America</span>
                  <span class="text-xs text-gray-500">•</span>
                  <span class="text-xs text-gray-500">Updated Dec 15, 2023</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Document Card 7 -->
          <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
            <div class="flex items-start gap-3">
              <i data-lucide="file-text" class="w-5 h-5 text-imf-blue flex-shrink-0 mt-0.5"></i>
              <div class="flex-1">
                <h4 class="font-medium text-gray-800 text-sm mb-1">Article IV Consultation - Indonesia 2023</h4>
                <p class="text-xs text-gray-600 mb-2">Economic assessment focusing on fiscal policy and financial stability</p>
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs" style="background: #EBF3FE; color: #004C97;">Surveillance Report</span>
                  <span class="text-xs text-gray-500">Asia-Pacific</span>
                  <span class="text-xs text-gray-500">•</span>
                  <span class="text-xs text-gray-500">Updated Dec 10, 2023</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Document Card 8 -->
          <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
            <div class="flex items-start gap-3">
              <i data-lucide="file-text" class="w-5 h-5 text-imf-blue flex-shrink-0 mt-0.5"></i>
              <div class="flex-1">
                <h4 class="font-medium text-gray-800 text-sm mb-1">Poverty Reduction Strategy - Ghana</h4>
                <p class="text-xs text-gray-600 mb-2">Country strategy document for sustainable development objectives</p>
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs" style="background: #F3F4F6; color: #6B7280;">Policy Document</span>
                  <span class="text-xs text-gray-500">Africa</span>
                  <span class="text-xs text-gray-500">•</span>
                  <span class="text-xs text-gray-500">Updated Dec 5, 2023</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Document Card 9 -->
          <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
            <div class="flex items-start gap-3">
              <i data-lucide="file-text" class="w-5 h-5 text-imf-blue flex-shrink-0 mt-0.5"></i>
              <div class="flex-1">
                <h4 class="font-medium text-gray-800 text-sm mb-1">Precautionary Liquidity Line - Poland</h4>
                <p class="text-xs text-gray-600 mb-2">Precautionary arrangement for countries with strong fundamentals</p>
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs" style="background: #FEF3E2; color: #D97706;">Lending Agreement</span>
                  <span class="text-xs text-gray-500">Europe</span>
                  <span class="text-xs text-gray-500">•</span>
                  <span class="text-xs text-gray-500">Updated Nov 28, 2023</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Document Card 10 -->
          <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
            <div class="flex items-start gap-3">
              <i data-lucide="file-text" class="w-5 h-5 text-imf-blue flex-shrink-0 mt-0.5"></i>
              <div class="flex-1">
                <h4 class="font-medium text-gray-800 text-sm mb-1">Article IV Consultation - Egypt 2023</h4>
                <p class="text-xs text-gray-600 mb-2">Comprehensive review of economic policies and external stability</p>
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs" style="background: #EBF3FE; color: #004C97;">Surveillance Report</span>
                  <span class="text-xs text-gray-500">Middle East</span>
                  <span class="text-xs text-gray-500">•</span>
                  <span class="text-xs text-gray-500">Updated Nov 20, 2023</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Document Card 11 -->
          <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
            <div class="flex items-start gap-3">
              <i data-lucide="file-text" class="w-5 h-5 text-imf-blue flex-shrink-0 mt-0.5"></i>
              <div class="flex-1">
                <h4 class="font-medium text-gray-800 text-sm mb-1">Extended Fund Facility - Pakistan</h4>
                <p class="text-xs text-gray-600 mb-2">Medium-term lending for structural balance of payments problems</p>
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs" style="background: #FEF3E2; color: #D97706;">Lending Agreement</span>
                  <span class="text-xs text-gray-500">Asia-Pacific</span>
                  <span class="text-xs text-gray-500">•</span>
                  <span class="text-xs text-gray-500">Updated Nov 15, 2023</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Document Card 12 -->
          <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
            <div class="flex items-start gap-3">
              <i data-lucide="file-text" class="w-5 h-5 text-imf-blue flex-shrink-0 mt-0.5"></i>
              <div class="flex-1">
                <h4 class="font-medium text-gray-800 text-sm mb-1">Regional Economic Outlook - Sub-Saharan Africa</h4>
                <p class="text-xs text-gray-600 mb-2">Semi-annual analysis of regional economic trends and outlook</p>
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs" style="background: #EBF3FE; color: #004C97;">Surveillance Report</span>
                  <span class="text-xs text-gray-500">Africa</span>
                  <span class="text-xs text-gray-500">•</span>
                  <span class="text-xs text-gray-500">Updated Nov 10, 2023</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Document Card 13 -->
          <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
            <div class="flex items-start gap-3">
              <i data-lucide="file-text" class="w-5 h-5 text-imf-blue flex-shrink-0 mt-0.5"></i>
              <div class="flex-1">
                <h4 class="font-medium text-gray-800 text-sm mb-1">Debt Sustainability Analysis - Tunisia</h4>
                <p class="text-xs text-gray-600 mb-2">Assessment of public debt trajectory and fiscal sustainability</p>
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs" style="background: #F3F4F6; color: #6B7280;">Policy Document</span>
                  <span class="text-xs text-gray-500">Middle East</span>
                  <span class="text-xs text-gray-500">•</span>
                  <span class="text-xs text-gray-500">Updated Nov 5, 2023</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Document Card 14 -->
          <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
            <div class="flex items-start gap-3">
              <i data-lucide="file-text" class="w-5 h-5 text-imf-blue flex-shrink-0 mt-0.5"></i>
              <div class="flex-1">
                <h4 class="font-medium text-gray-800 text-sm mb-1">Article IV Consultation - Vietnam 2023</h4>
                <p class="text-xs text-gray-600 mb-2">Assessment of macroeconomic performance and policy recommendations</p>
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs" style="background: #EBF3FE; color: #004C97;">Surveillance Report</span>
                  <span class="text-xs text-gray-500">Asia-Pacific</span>
                  <span class="text-xs text-gray-500">•</span>
                  <span class="text-xs text-gray-500">Updated Oct 30, 2023</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Document Card 15 -->
          <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
            <div class="flex items-start gap-3">
              <i data-lucide="file-text" class="w-5 h-5 text-imf-blue flex-shrink-0 mt-0.5"></i>
              <div class="flex-1">
                <h4 class="font-medium text-gray-800 text-sm mb-1">Conditionality Template - ECF Programs</h4>
                <p class="text-xs text-gray-600 mb-2">Standard conditions and benchmarks for Extended Credit Facility</p>
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs" style="background: #F0FDF4; color: #16A34A;">Template</span>
                  <span class="text-xs text-gray-500">Global</span>
                  <span class="text-xs text-gray-500">•</span>
                  <span class="text-xs text-gray-500">Updated Oct 25, 2023</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Document Card 16 -->
          <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
            <div class="flex items-start gap-3">
              <i data-lucide="file-text" class="w-5 h-5 text-imf-blue flex-shrink-0 mt-0.5"></i>
              <div class="flex-1">
                <h4 class="font-medium text-gray-800 text-sm mb-1">Flexible Credit Line - Chile</h4>
                <p class="text-xs text-gray-600 mb-2">Precautionary instrument for strong-performing economies</p>
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs" style="background: #FEF3E2; color: #D97706;">Lending Agreement</span>
                  <span class="text-xs text-gray-500">Latin America</span>
                  <span class="text-xs text-gray-500">•</span>
                  <span class="text-xs text-gray-500">Updated Oct 20, 2023</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Document Card 17 -->
          <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
            <div class="flex items-start gap-3">
              <i data-lucide="file-text" class="w-5 h-5 text-imf-blue flex-shrink-0 mt-0.5"></i>
              <div class="flex-1">
                <h4 class="font-medium text-gray-800 text-sm mb-1">Article IV Consultation - South Africa 2023</h4>
                <p class="text-xs text-gray-600 mb-2">Economic surveillance focusing on growth, employment, and inequality</p>
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs" style="background: #EBF3FE; color: #004C97;">Surveillance Report</span>
                  <span class="text-xs text-gray-500">Africa</span>
                  <span class="text-xs text-gray-500">•</span>
                  <span class="text-xs text-gray-500">Updated Oct 15, 2023</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Document Card 18 -->
          <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
            <div class="flex items-start gap-3">
              <i data-lucide="file-text" class="w-5 h-5 text-imf-blue flex-shrink-0 mt-0.5"></i>
              <div class="flex-1">
                <h4 class="font-medium text-gray-800 text-sm mb-1">Stand-By Credit Facility - Zambia</h4>
                <p class="text-xs text-gray-600 mb-2">Short-term financing for low-income countries facing urgent needs</p>
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs" style="background: #FEF3E2; color: #D97706;">Lending Agreement</span>
                  <span class="text-xs text-gray-500">Africa</span>
                  <span class="text-xs text-gray-500">•</span>
                  <span class="text-xs text-gray-500">Updated Oct 10, 2023</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Document Card 19 -->
          <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
            <div class="flex items-start gap-3">
              <i data-lucide="file-text" class="w-5 h-5 text-imf-blue flex-shrink-0 mt-0.5"></i>
              <div class="flex-1">
                <h4 class="font-medium text-gray-800 text-sm mb-1">Financial Sector Assessment - UAE</h4>
                <p class="text-xs text-gray-600 mb-2">Comprehensive evaluation of financial system stability and soundness</p>
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs" style="background: #F3F4F6; color: #6B7280;">Policy Document</span>
                  <span class="text-xs text-gray-500">Middle East</span>
                  <span class="text-xs text-gray-500">•</span>
                  <span class="text-xs text-gray-500">Updated Oct 5, 2023</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Document Card 20 -->
          <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
            <div class="flex items-start gap-3">
              <i data-lucide="file-text" class="w-5 h-5 text-imf-blue flex-shrink-0 mt-0.5"></i>
              <div class="flex-1">
                <h4 class="font-medium text-gray-800 text-sm mb-1">Article IV Consultation - Brazil 2023</h4>
                <p class="text-xs text-gray-600 mb-2">Economic review covering fiscal consolidation and structural reforms</p>
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs" style="background: #EBF3FE; color: #004C97;">Surveillance Report</span>
                  <span class="text-xs text-gray-500">Latin America</span>
                  <span class="text-xs text-gray-500">•</span>
                  <span class="text-xs text-gray-500">Updated Sep 28, 2023</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Document Card 21 -->
          <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
            <div class="flex items-start gap-3">
              <i data-lucide="file-text" class="w-5 h-5 text-imf-blue flex-shrink-0 mt-0.5"></i>
              <div class="flex-1">
                <h4 class="font-medium text-gray-800 text-sm mb-1">Rapid Credit Facility - Madagascar</h4>
                <p class="text-xs text-gray-600 mb-2">Emergency assistance for low-income countries with urgent needs</p>
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs" style="background: #FEE2E2; color: #DC2626;">Emergency Lending</span>
                  <span class="text-xs text-gray-500">Africa</span>
                  <span class="text-xs text-gray-500">•</span>
                  <span class="text-xs text-gray-500">Updated Sep 22, 2023</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Document Card 22 -->
          <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
            <div class="flex items-start gap-3">
              <i data-lucide="file-text" class="w-5 h-5 text-imf-blue flex-shrink-0 mt-0.5"></i>
              <div class="flex-1">
                <h4 class="font-medium text-gray-800 text-sm mb-1">Article IV Consultation - Turkey 2023</h4>
                <p class="text-xs text-gray-600 mb-2">Assessment focusing on inflation dynamics and monetary policy framework</p>
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs" style="background: #EBF3FE; color: #004C97;">Surveillance Report</span>
                  <span class="text-xs text-gray-500">Europe</span>
                  <span class="text-xs text-gray-500">•</span>
                  <span class="text-xs text-gray-500">Updated Sep 18, 2023</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Document Card 23 -->
          <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
            <div class="flex items-start gap-3">
              <i data-lucide="file-text" class="w-5 h-5 text-imf-blue flex-shrink-0 mt-0.5"></i>
              <div class="flex-1">
                <h4 class="font-medium text-gray-800 text-sm mb-1">Program Review Guidelines - SBA</h4>
                <p class="text-xs text-gray-600 mb-2">Standard procedures for Stand-By Arrangement program reviews</p>
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs" style="background: #F0FDF4; color: #16A34A;">Template</span>
                  <span class="text-xs text-gray-500">Global</span>
                  <span class="text-xs text-gray-500">•</span>
                  <span class="text-xs text-gray-500">Updated Sep 15, 2023</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Document Card 24 -->
          <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
            <div class="flex items-start gap-3">
              <i data-lucide="file-text" class="w-5 h-5 text-imf-blue flex-shrink-0 mt-0.5"></i>
              <div class="flex-1">
                <h4 class="font-medium text-gray-800 text-sm mb-1">Extended Credit Facility - Senegal</h4>
                <p class="text-xs text-gray-600 mb-2">Three-year program supporting poverty reduction and growth</p>
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs" style="background: #FEF3E2; color: #D97706;">Lending Agreement</span>
                  <span class="text-xs text-gray-500">Africa</span>
                  <span class="text-xs text-gray-500">•</span>
                  <span class="text-xs text-gray-500">Updated Sep 10, 2023</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Document Card 25 -->
          <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
            <div class="flex items-start gap-3">
              <i data-lucide="file-text" class="w-5 h-5 text-imf-blue flex-shrink-0 mt-0.5"></i>
              <div class="flex-1">
                <h4 class="font-medium text-gray-800 text-sm mb-1">Article IV Consultation - Thailand 2023</h4>
                <p class="text-xs text-gray-600 mb-2">Economic surveillance emphasizing post-pandemic recovery strategies</p>
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs" style="background: #EBF3FE; color: #004C97;">Surveillance Report</span>
                  <span class="text-xs text-gray-500">Asia-Pacific</span>
                  <span class="text-xs text-gray-500">•</span>
                  <span class="text-xs text-gray-500">Updated Sep 5, 2023</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Document Card 26 -->
          <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
            <div class="flex items-start gap-3">
              <i data-lucide="file-text" class="w-5 h-5 text-imf-blue flex-shrink-0 mt-0.5"></i>
              <div class="flex-1">
                <h4 class="font-medium text-gray-800 text-sm mb-1">Debt Restructuring Framework - Sri Lanka</h4>
                <p class="text-xs text-gray-600 mb-2">Policy framework for sovereign debt restructuring and sustainability</p>
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs" style="background: #F3F4F6; color: #6B7280;">Policy Document</span>
                  <span class="text-xs text-gray-500">Asia-Pacific</span>
                  <span class="text-xs text-gray-500">•</span>
                  <span class="text-xs text-gray-500">Updated Aug 30, 2023</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Document Card 27 -->
          <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
            <div class="flex items-start gap-3">
              <i data-lucide="file-text" class="w-5 h-5 text-imf-blue flex-shrink-0 mt-0.5"></i>
              <div class="flex-1">
                <h4 class="font-medium text-gray-800 text-sm mb-1">Article IV Consultation - Nigeria 2023</h4>
                <p class="text-xs text-gray-600 mb-2">Economic assessment covering oil sector reforms and diversification</p>
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs" style="background: #EBF3FE; color: #004C97;">Surveillance Report</span>
                  <span class="text-xs text-gray-500">Africa</span>
                  <span class="text-xs text-gray-500">•</span>
                  <span class="text-xs text-gray-500">Updated Aug 25, 2023</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Document Card 28 -->
          <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
            <div class="flex items-start gap-3">
              <i data-lucide="file-text" class="w-5 h-5 text-imf-blue flex-shrink-0 mt-0.5"></i>
              <div class="flex-1">
                <h4 class="font-medium text-gray-800 text-sm mb-1">Stand-By Arrangement - Ukraine 2023</h4>
                <p class="text-xs text-gray-600 mb-2">Financial support program amid ongoing economic challenges</p>
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs" style="background: #FEF3E2; color: #D97706;">Lending Agreement</span>
                  <span class="text-xs text-gray-500">Europe</span>
                  <span class="text-xs text-gray-500">•</span>
                  <span class="text-xs text-gray-500">Updated Aug 20, 2023</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Document Card 29 -->
          <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
            <div class="flex items-start gap-3">
              <i data-lucide="file-text" class="w-5 h-5 text-imf-blue flex-shrink-0 mt-0.5"></i>
              <div class="flex-1">
                <h4 class="font-medium text-gray-800 text-sm mb-1">Climate Policy Assessment - Philippines</h4>
                <p class="text-xs text-gray-600 mb-2">Analysis of climate-related fiscal risks and adaptation strategies</p>
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs" style="background: #F3F4F6; color: #6B7280;">Policy Document</span>
                  <span class="text-xs text-gray-500">Asia-Pacific</span>
                  <span class="text-xs text-gray-500">•</span>
                  <span class="text-xs text-gray-500">Updated Aug 15, 2023</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Document Card 30 -->
          <div class="rounded-lg border border-gray-200 bg-white p-4 hover:bg-gray-50 transition-all cursor-pointer" style="box-shadow: 0 2px 8px rgba(0,0,0,.04);">
            <div class="flex items-start gap-3">
              <i data-lucide="file-text" class="w-5 h-5 text-imf-blue flex-shrink-0 mt-0.5"></i>
              <div class="flex-1">
                <h4 class="font-medium text-gray-800 text-sm mb-1">Article IV Consultation - Mexico 2023</h4>
                <p class="text-xs text-gray-600 mb-2">Economic surveillance focusing on nearshoring opportunities and risks</p>
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs" style="background: #EBF3FE; color: #004C97;">Surveillance Report</span>
                  <span class="text-xs text-gray-500">Latin America</span>
                  <span class="text-xs text-gray-500">•</span>
                  <span class="text-xs text-gray-500">Updated Aug 10, 2023</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Pagination -->
        <div class="flex items-center justify-between mt-6 pt-4 border-t border-gray-200">
          <div class="text-sm text-gray-600">
            Showing <span class="font-medium">1-30</span> of <span class="font-medium">1,247</span> documents
          </div>
          <div class="flex items-center gap-2">
            <button disabled class="px-3 py-2 text-sm font-medium text-gray-400 bg-white border border-gray-200 rounded-lg cursor-not-allowed">
              <i data-lucide="chevron-left" class="w-4 h-4"></i>
            </button>
            <button class="px-3 py-2 text-sm font-medium text-white rounded-lg" style="background: linear-gradient(135deg, #004C97, #0060BF);">1</button>
            <button class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-lg hover:bg-gray-50">2</button>
            <button class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-lg hover:bg-gray-50">3</button>
            <span class="px-2 text-gray-500">...</span>
            <button class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-lg hover:bg-gray-50">42</button>
            <button class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-lg hover:bg-gray-50">
              <i data-lucide="chevron-right" class="w-4 h-4"></i>
            </button>
          </div>
        </div>
      </div>
  `;
}

/* ────── Init ────── */
buildDots();

// Check for hash navigation from hr-summary.html
if (window.location.hash === '#step1') {
  renderUpToStep(1);
  // Clear the hash
  history.replaceState(null, null, ' ');
} else {
  renderUpToStep(0);
  // Set initial active state for New Task link
  document.getElementById('new-chat-link').classList.add('active');

  // Show bottom input area
  const bottomInputArea = document.getElementById('bottom-input-area');
  if (bottomInputArea) {
    bottomInputArea.style.display = 'block';
  }

  // Open canvas panel by default with search interface for New Task
  const canvasPanel = document.getElementById('canvas-panel');
  const canvasContent = document.getElementById('canvas-content');
  if (canvasPanel && canvasContent) {
    canvasContent.innerHTML = generateSearchInterfaceHTML();
    canvasPanel.classList.add('open');
    lucide.createIcons();
  }
}
</script>
</body>
</html>
